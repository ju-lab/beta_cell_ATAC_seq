\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Untitled},
            pdfauthor={Kijong Yi},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}
  \title{Untitled}
  \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
  \author{Kijong Yi}
  \preauthor{\centering\large\emph}
  \postauthor{\par}
  \predate{\centering\large\emph}
  \postdate{\par}
  \date{201859}


\begin{document}
\maketitle

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# }\AlertTok{TODO}\CommentTok{: Add comment}
\CommentTok{# }
\CommentTok{# Author: mg14}
\NormalTok{###############################################################################}

\KeywordTok{library}\NormalTok{(Rsamtools)}

\NormalTok{vcfPath <-}\StringTok{ '~/pcawg/final/final_consensus_12oct_passonly/snv_mnv'}
\NormalTok{basePath <-}\StringTok{  '~/pcawg/dp/20170129_dpclust_finalConsensusCopynum_levels_a_b_c_d'}
\NormalTok{dpPath <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{'~/pcawg/final/consensus_subclonal_reconstruction_20170325'}\NormalTok{)}
\CommentTok{#CANCERGENES <- read.table('~/pcawg/ref/cancer_genes.txt')$V1}
\NormalTok{purityPloidy <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{( }\StringTok{'~/pcawg/final/consensus.20170218.purity.ploidy.txt'}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{row.names=}\DecValTok{1}\NormalTok{)}
\CommentTok{#colnames(purityPloidy) <- c("purity","ploidy")}
\NormalTok{cnPath <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(basePath,}\StringTok{'/4_copynumber/'}\NormalTok{)}
\NormalTok{bbPath <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(basePath,}\StringTok{'/4_copynumber/'}\NormalTok{)}

\NormalTok{allGender <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{'~/pcawg/gender/2016_12_09_inferred_sex_all_samples.txt'}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{'}\CharTok{\textbackslash{}t}\StringTok{'}\NormalTok{)}
\NormalTok{allGender <-}\StringTok{ }\NormalTok{allGender[}\OperatorTok{!}\KeywordTok{duplicated}\NormalTok{(allGender}\OperatorTok{$}\NormalTok{tumourid) }\OperatorTok{&}\StringTok{ }\NormalTok{allGender}\OperatorTok{$}\NormalTok{tumourid }\OperatorTok{!=}\StringTok{ 'tumourid'}\NormalTok{,]}
\CommentTok{#write.table(gender,'~/pcawg/gender/2016_12_09_inferred_sex_all_samples_CORRECTED_MG.txt', row.names=FALSE, col.names=TRUE, sep='\textbackslash{}t', quote=FALSE)}
\KeywordTok{rownames}\NormalTok{(allGender) <-}\StringTok{ }\NormalTok{allGender}\OperatorTok{$}\NormalTok{tumourid}

\NormalTok{addTNC <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{    }
\NormalTok{  r =}\StringTok{ "/lustre/scratch112/sanger/cgppipe/PanCancerReference/genome.fa.gz"} \CommentTok{#meta(header(v))["reference",]}
  \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\StringTok{"TNC"} \OperatorTok{%in%}\StringTok{ }\KeywordTok{rownames}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO))\{}
\NormalTok{    tnc=}\KeywordTok{scanFa}\NormalTok{(}\DataTypeTok{file=}\NormalTok{r, }\KeywordTok{resize}\NormalTok{(}\KeywordTok{granges}\NormalTok{(vcf), }\DecValTok{3}\NormalTok{,}\DataTypeTok{fix=}\StringTok{"center"}\NormalTok{))}
\NormalTok{    i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
    \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\DecValTok{1}\NormalTok{,}\DataTypeTok{Type=}\StringTok{"String"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"Trinucleotide context"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"TNC"}\NormalTok{))}
    \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{TNC <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(tnc)}
\NormalTok{  \}}
  \KeywordTok{return}\NormalTok{(vcf)}
\NormalTok{\}}

\NormalTok{dpFiles <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(dpPath, }\DataTypeTok{pattern=}\StringTok{"_subclonal_structure.txt"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{bbFiles <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(bbPath, }\DataTypeTok{pattern=}\StringTok{"_segments.txt"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{)}

\NormalTok{wccTable <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"~/pcawg/final/wcc_consensus_values_9_12.tsv"}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{'}\CharTok{\textbackslash{}t}\StringTok{'}\NormalTok{)}
\NormalTok{d <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{cluster=}\NormalTok{wccTable}\OperatorTok{$}\NormalTok{sc_n, }\DataTypeTok{n_ssms=}\NormalTok{wccTable}\OperatorTok{$}\NormalTok{consensus_mutation_number, }\DataTypeTok{proportion =} \KeywordTok{round}\NormalTok{(wccTable}\OperatorTok{$}\NormalTok{consensus_cluster_cp,}\DecValTok{3}\NormalTok{))}
\NormalTok{d[d}\OperatorTok{$}\NormalTok{cluster}\OperatorTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"proportion"}\NormalTok{] <-}\StringTok{ }\NormalTok{wccTable[d}\OperatorTok{$}\NormalTok{cluster}\OperatorTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"purity"}\NormalTok{]}
\NormalTok{wccClusters <-}\StringTok{ }\KeywordTok{split}\NormalTok{(d, wccTable}\OperatorTok{$}\NormalTok{sid)}
\NormalTok{wccPurity <-}\StringTok{ }\NormalTok{d[d}\OperatorTok{$}\NormalTok{cluster}\OperatorTok{==}\DecValTok{1}\NormalTok{,}\StringTok{"proportion"}\NormalTok{] }
\CommentTok{#plot(wccPurity, purityPloidy[,"purity"])}

\NormalTok{loadClusters <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(dpPath,}\StringTok{"/"}\NormalTok{,}\KeywordTok{grep}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(ID,}\StringTok{"[[:punct:]]"}\NormalTok{), dpFiles, }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{".gz"}\NormalTok{, file))}
\NormalTok{    file <-}\StringTok{ }\KeywordTok{gzfile}\NormalTok{(file)}
  \KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{loadConsensusClusters <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(dpPath,}\StringTok{"/"}\NormalTok{,}\KeywordTok{grep}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(ID,}\StringTok{"[[:punct:]]"}\NormalTok{), dpFiles, }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{".gz"}\NormalTok{, file))}
\NormalTok{    file <-}\StringTok{ }\KeywordTok{gzfile}\NormalTok{(file)}
  \KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{consensusClustersToOld <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(clusters)\{}
  \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{cluster=}\NormalTok{clusters}\OperatorTok{$}\NormalTok{cluster, }\DataTypeTok{n_ssms=}\NormalTok{clusters}\OperatorTok{$}\NormalTok{n_snvs, }\DataTypeTok{proportion=}\NormalTok{clusters}\OperatorTok{$}\NormalTok{fraction_total_cells)}
\NormalTok{\}}

\NormalTok{parseRegion <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(regions)\{}
\NormalTok{  chr <-}\StringTok{ }\KeywordTok{regmatches}\NormalTok{(regions, }\KeywordTok{regexpr}\NormalTok{(}\StringTok{"^.+(?=:)"}\NormalTok{,regions,}\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{))}
\NormalTok{  start <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{regmatches}\NormalTok{(regions, }\KeywordTok{regexpr}\NormalTok{(}\StringTok{"(?<=:)[0-9]+(?=-)"}\NormalTok{,regions,}\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{)))}
\NormalTok{  end <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{regmatches}\NormalTok{(regions, }\KeywordTok{regexpr}\NormalTok{(}\StringTok{"(?<=-)[0-9]+$"}\NormalTok{,regions,}\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{)))}
  \KeywordTok{data.frame}\NormalTok{(chr,start,end)}
\NormalTok{\}}

\NormalTok{loadCn <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(cnPath, }\StringTok{"/"}\NormalTok{,ID,}\StringTok{"_timingsMle.txt"}\NormalTok{)}
\NormalTok{  tab <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{" "}\NormalTok{)}
\NormalTok{  reg <-}\StringTok{ }\KeywordTok{parseRegion}\NormalTok{(tab}\OperatorTok{$}\NormalTok{ascatId)}
  \KeywordTok{GRanges}\NormalTok{(tab}\OperatorTok{$}\NormalTok{chr, }\KeywordTok{IRanges}\NormalTok{(reg}\OperatorTok{$}\NormalTok{start,reg}\OperatorTok{$}\NormalTok{end), }\DataTypeTok{strand=}\StringTok{"*"}\NormalTok{, tab[}\OperatorTok{-}\DecValTok{1}\NormalTok{])}
\NormalTok{\}}

\NormalTok{loadBB <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{try}\NormalTok{(\{}
\NormalTok{    file <-}\StringTok{ }\KeywordTok{grep}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(ID,}\StringTok{"[[:punct:]]"}\NormalTok{), }\KeywordTok{dir}\NormalTok{(bbPath, }\DataTypeTok{pattern=}\StringTok{"segments.txt"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{".gz"}\NormalTok{, file))}
\NormalTok{      file <-}\StringTok{ }\KeywordTok{gzfile}\NormalTok{(file)}
\NormalTok{    tab <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{'}\CharTok{\textbackslash{}t}\StringTok{'}\NormalTok{)}
    \KeywordTok{GRanges}\NormalTok{(tab}\OperatorTok{$}\NormalTok{chromosome, }\KeywordTok{IRanges}\NormalTok{(tab}\OperatorTok{$}\NormalTok{start, tab}\OperatorTok{$}\NormalTok{end), }\DataTypeTok{strand=}\StringTok{"*"}\NormalTok{, tab[}\OperatorTok{-}\DecValTok{3}\OperatorTok{:-}\DecValTok{1}\NormalTok{])}
\NormalTok{  \})}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{class}\NormalTok{(t)}\OperatorTok{==}\StringTok{'try-error'}\NormalTok{) }\KeywordTok{GRanges}\NormalTok{(}\DataTypeTok{copy_number=}\KeywordTok{numeric}\NormalTok{(), }\DataTypeTok{major_cn=}\KeywordTok{numeric}\NormalTok{(), }\DataTypeTok{minor_cn=}\KeywordTok{numeric}\NormalTok{(), }\DataTypeTok{clonal_frequency=}\KeywordTok{numeric}\NormalTok{()) }\ControlFlowTok{else}\NormalTok{ t}
\NormalTok{\}}

\NormalTok{loadConsensusCNA <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID, }\DataTypeTok{purity=}\DecValTok{1}\NormalTok{, }\DataTypeTok{path=}\StringTok{"/lustre/scratch112/sanger/cgppipe/PanCancerDownloads/workspace/mg14/final/consensus.20170119.somatic.cna.annotated"}\NormalTok{)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{grep}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(ID,}\StringTok{"[[:punct:]]"}\NormalTok{), }\KeywordTok{dir}\NormalTok{(path, }\DataTypeTok{pattern=}\StringTok{"cna.annotated.txt"}\NormalTok{, }\DataTypeTok{recursive=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{), }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{".gz"}\NormalTok{, file))}
\NormalTok{    file <-}\StringTok{ }\KeywordTok{gzfile}\NormalTok{(file)}
\NormalTok{  tab <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{'}\CharTok{\textbackslash{}t}\StringTok{'}\NormalTok{)}
\NormalTok{  subclonalIndex <-}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab}\OperatorTok{$}\NormalTok{total_cn) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab}\OperatorTok{$}\NormalTok{battenberg_nMaj2_A) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab}\OperatorTok{$}\NormalTok{battenberg_nMin2_A) }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(tab}\OperatorTok{$}\NormalTok{battenberg_frac2_A) }\OperatorTok{&}\StringTok{ }\NormalTok{(tab}\OperatorTok{$}\NormalTok{battenberg_nMaj1_A }\OperatorTok{==}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{major_cn }\OperatorTok{&}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin1_A }\OperatorTok{==}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{minor_cn }\OperatorTok{|}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMaj2_A }\OperatorTok{==}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{major_cn }\OperatorTok{&}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin2_A }\OperatorTok{==}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{minor_cn)}
\NormalTok{  ix <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(tab), }\KeywordTok{which}\NormalTok{(subclonalIndex))}
\NormalTok{  gr <-}\StringTok{ }\KeywordTok{GRanges}\NormalTok{(tab}\OperatorTok{$}\NormalTok{chromosome, }\KeywordTok{IRanges}\NormalTok{(tab}\OperatorTok{$}\NormalTok{start, tab}\OperatorTok{$}\NormalTok{end), }\DataTypeTok{strand=}\StringTok{"*"}\NormalTok{, }\DataTypeTok{clonal_frequency=}\NormalTok{purity, tab[}\OperatorTok{-}\DecValTok{3}\OperatorTok{:-}\DecValTok{1}\NormalTok{])[ix]}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(subclonalIndex))\{}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{clonal_frequency[}\KeywordTok{which}\NormalTok{(subclonalIndex)] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_frac1_A[subclonalIndex] }\OperatorTok{*}\StringTok{ }\NormalTok{purity}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{major_cn[}\KeywordTok{which}\NormalTok{(subclonalIndex)] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMaj1_A[subclonalIndex]}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{minor_cn[}\KeywordTok{which}\NormalTok{(subclonalIndex)] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin1_A[subclonalIndex]}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{total_cn[}\KeywordTok{which}\NormalTok{(subclonalIndex)] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMaj1_A[subclonalIndex] }\OperatorTok{+}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin1_A[subclonalIndex]}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{clonal_frequency[}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(tab))] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_frac2_A[subclonalIndex] }\OperatorTok{*}\StringTok{ }\NormalTok{purity}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{total_cn[}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(tab))] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMaj2_A[subclonalIndex] }\OperatorTok{+}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin2_A[subclonalIndex]}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{major_cn[}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(tab))] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMaj2_A[subclonalIndex]}
\NormalTok{    gr}\OperatorTok{$}\NormalTok{minor_cn[}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(tab))] <-}\StringTok{ }\NormalTok{tab}\OperatorTok{$}\NormalTok{battenberg_nMin2_A[subclonalIndex]}
\NormalTok{  \}}
  \KeywordTok{seqlevels}\NormalTok{(gr) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{22}\NormalTok{, }\StringTok{"X"}\NormalTok{,}\StringTok{"Y"}\NormalTok{)}
  \KeywordTok{sort}\NormalTok{(gr)}
\NormalTok{\}}

\NormalTok{refFile =}\StringTok{ "/lustre/scratch112/sanger/cgppipe/PanCancerReference/genome.fa.gz"} \CommentTok{#meta(header(v))["reference",]}
\NormalTok{refLengths <-}\StringTok{ }\KeywordTok{scanFaIndex}\NormalTok{(}\DataTypeTok{file=}\NormalTok{refFile)}
\NormalTok{chrOffset <-}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(refLengths))))}
\KeywordTok{names}\NormalTok{(chrOffset) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{seqlevels}\NormalTok{(refLengths), }\StringTok{"NA"}\NormalTok{)}

\NormalTok{averagePloidy <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb) \{}
\NormalTok{  c <-}\StringTok{ }\ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.null}\NormalTok{(bb}\OperatorTok{$}\NormalTok{copy_number)) bb}\OperatorTok{$}\NormalTok{copy_number }\ControlFlowTok{else}\NormalTok{ bb}\OperatorTok{$}\NormalTok{total_cn}
  \KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{c }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\NormalTok{averageEvenPloidy <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb)\{}
  \KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{(}\OperatorTok{!}\NormalTok{bb}\OperatorTok{$}\NormalTok{major_cn }\OperatorTok{%%}\StringTok{ }\DecValTok{2} \OperatorTok{&}\StringTok{ }\OperatorTok{!}\NormalTok{bb}\OperatorTok{$}\NormalTok{minor_cn }\OperatorTok{%%}\StringTok{ }\DecValTok{2}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\NormalTok{getTumorCounts <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
  \KeywordTok{sapply}\NormalTok{(}\KeywordTok{grep}\NormalTok{(}\StringTok{"(F|R).Z"}\NormalTok{, }\KeywordTok{names}\NormalTok{(}\KeywordTok{geno}\NormalTok{(vcf)), }\DataTypeTok{value=}\OtherTok{TRUE}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(i) }\KeywordTok{geno}\NormalTok{(vcf)[[i]][,}\StringTok{"TUMOUR"}\NormalTok{])}
\NormalTok{\}}

\NormalTok{getTumorDepth <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
  \ControlFlowTok{if}\NormalTok{(}\StringTok{"t_alt_count"} \OperatorTok{%in%}\StringTok{ }\KeywordTok{colnames}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)))\{ ## consensus data, snv and indel}
    \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{t_alt_count }\OperatorTok{+}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{t_ref_count}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{ ## older data}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"FAZ"} \OperatorTok{%in%}\StringTok{ }\KeywordTok{rownames}\NormalTok{(}\KeywordTok{geno}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))))\{}
      \KeywordTok{rowSums}\NormalTok{(}\KeywordTok{getTumorCounts}\NormalTok{(vcf))}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \KeywordTok{geno}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DEP[,}\DecValTok{2}\NormalTok{]}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{getAltCount <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
  \ControlFlowTok{if}\NormalTok{(}\StringTok{"t_alt_count"} \OperatorTok{%in%}\StringTok{ }\KeywordTok{colnames}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)))\{ ## consensus data, snv and indel}
    \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{t_alt_count}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{ ## older formats}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"FAZ"} \OperatorTok{%in%}\StringTok{ }\KeywordTok{rownames}\NormalTok{(}\KeywordTok{geno}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))))\{ ## ie subs}
\NormalTok{      c <-}\StringTok{ }\KeywordTok{getTumorCounts}\NormalTok{(vcf)}
\NormalTok{      t <-}\StringTok{ }\NormalTok{c[,}\DecValTok{1}\OperatorTok{:}\DecValTok{4}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{c[,}\DecValTok{5}\OperatorTok{:}\DecValTok{8}\NormalTok{]}
      \KeywordTok{colnames}\NormalTok{(t) <-}\StringTok{ }\KeywordTok{substring}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(t),}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{)}
\NormalTok{      a <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{alt}\NormalTok{(vcf)))}
\NormalTok{      a[}\OperatorTok{!}\NormalTok{a}\OperatorTok{%in%}\KeywordTok{c}\NormalTok{(}\StringTok{'A'}\NormalTok{,}\StringTok{'T'}\NormalTok{,}\StringTok{'C'}\NormalTok{,}\StringTok{'G'}\NormalTok{)] <-}\StringTok{ }\OtherTok{NA}
      \KeywordTok{sapply}\NormalTok{(}\KeywordTok{seq_along}\NormalTok{(a), }\ControlFlowTok{function}\NormalTok{(i) }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(a[i])) }\OtherTok{NA} \ControlFlowTok{else}\NormalTok{ t[i, a[i]])}
\NormalTok{    \}}
    \ControlFlowTok{else}\NormalTok{\{ ## ie indel}
      \CommentTok{#(geno(vcf)$PP + geno(vcf)$NP + geno(vcf)$PB + geno(vcf)$NB)[,"TUMOUR"]}
      \KeywordTok{geno}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MTR[,}\DecValTok{2}\NormalTok{]}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}



\NormalTok{mergeClusters <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(clusters, }\DataTypeTok{deltaFreq=}\FloatTok{0.05}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(clusters) }\OperatorTok{<=}\StringTok{ }\DecValTok{1}\NormalTok{) }\KeywordTok{return}\NormalTok{(clusters)}
\NormalTok{  h <-}\StringTok{ }\KeywordTok{hclust}\NormalTok{(}\KeywordTok{dist}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{proportion), }\DataTypeTok{members=}\NormalTok{clusters}\OperatorTok{$}\NormalTok{n_ssms)}
\NormalTok{  ct <-}\StringTok{ }\KeywordTok{cutree}\NormalTok{(h, }\DataTypeTok{h=}\NormalTok{deltaFreq)}
\NormalTok{  cp <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{cophenetic}\NormalTok{(h))}
  \KeywordTok{Reduce}\NormalTok{(}\StringTok{"rbind"}\NormalTok{,}\KeywordTok{lapply}\NormalTok{(}\KeywordTok{unique}\NormalTok{(ct), }\ControlFlowTok{function}\NormalTok{(i) \{}
\NormalTok{    n_ssms <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{n_ssms[ct}\OperatorTok{==}\NormalTok{i])}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{max}\NormalTok{(cp[ct}\OperatorTok{==}\NormalTok{i,ct}\OperatorTok{==}\NormalTok{i])}
    \KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{new.cluster=}\NormalTok{i, }\DataTypeTok{n_ssms=}\NormalTok{n_ssms, }\DataTypeTok{proportion=}\KeywordTok{sum}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{proportion[ct}\OperatorTok{==}\NormalTok{i]}\OperatorTok{*}\NormalTok{clusters}\OperatorTok{$}\NormalTok{n_ssms[ct}\OperatorTok{==}\NormalTok{i])}\OperatorTok{/}\NormalTok{n_ssms, }\DataTypeTok{width=}\NormalTok{w)}
\NormalTok{  \}}
\NormalTok{  ))}
\NormalTok{\}}


\NormalTok{removeSuperclones <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(clusters, }\DataTypeTok{min.frac=}\FloatTok{0.1}\NormalTok{, }\DataTypeTok{delta.prop=}\FloatTok{0.1}\NormalTok{) \{}
\NormalTok{  m <-}\StringTok{ }\KeywordTok{which}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{proportion }\OperatorTok{==}\StringTok{ }\KeywordTok{max}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{proportion[clusters}\OperatorTok{$}\NormalTok{n_ssms }\OperatorTok{>=}\StringTok{ }\FloatTok{0.1} \OperatorTok{*}\StringTok{ }\KeywordTok{sum}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{n_ssms)]))}
\NormalTok{  w <-}\StringTok{ }\NormalTok{clusters}\OperatorTok{$}\NormalTok{proportion }\OperatorTok{>=}\StringTok{ }\NormalTok{clusters}\OperatorTok{$}\NormalTok{proportion[m] }\OperatorTok{-}\StringTok{ }\NormalTok{delta.prop}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{sum}\NormalTok{(w)}\OperatorTok{>}\DecValTok{1}\NormalTok{)\{}
\NormalTok{    cl <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(}\OperatorTok{!}\NormalTok{w)) clusters[}\OperatorTok{!}\NormalTok{w,,}\DataTypeTok{drop=}\OtherTok{FALSE}\NormalTok{], }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(w)) }\KeywordTok{colSums}\NormalTok{(clusters[w,,}\DataTypeTok{drop=}\OtherTok{FALSE}\NormalTok{]}\OperatorTok{*}\NormalTok{(clusters[w,}\StringTok{"n_ssms"}\NormalTok{]}\OperatorTok{/}\KeywordTok{sum}\NormalTok{(clusters[w,}\StringTok{"n_ssms"}\NormalTok{])))))}
\NormalTok{    cl[}\KeywordTok{nrow}\NormalTok{(cl),}\StringTok{"n_ssms"}\NormalTok{] <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(clusters[w,}\StringTok{"n_ssms"}\NormalTok{])}
\NormalTok{    clusters <-}\StringTok{ }\NormalTok{cl}
\NormalTok{  \}}
  \KeywordTok{return}\NormalTok{(clusters)}
\NormalTok{\}}

\NormalTok{clustersFromBB <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb)\{}
\NormalTok{  w <-}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency }\OperatorTok{==}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{|}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency }\OperatorTok{<}\StringTok{ }\FloatTok{0.5} \OperatorTok{*}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{table}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency[w])}
\NormalTok{  cl <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{cluster=}\KeywordTok{seq_along}\NormalTok{(t), }\DataTypeTok{n_ssms=}\KeywordTok{as.numeric}\NormalTok{(t), }\DataTypeTok{proportion=}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{names}\NormalTok{(t)))}
  \KeywordTok{mergeClusters}\NormalTok{(cl, }\DataTypeTok{deltaFreq=}\FloatTok{0.2}\NormalTok{)}
\NormalTok{\}}



\NormalTok{probGenotype <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
\NormalTok{  dg <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG)), }\DataTypeTok{levels=}\KeywordTok{c}\NormalTok{(}\StringTok{"NA"}\NormalTok{,}\KeywordTok{as.character}\NormalTok{(CANCERGENES)))}
\NormalTok{  P <-}\StringTok{ }\KeywordTok{pGainToTime}\NormalTok{(vcf)}
\NormalTok{  G <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{ncol=}\DecValTok{5}\NormalTok{, }\DataTypeTok{nrow=}\KeywordTok{nlevels}\NormalTok{(dg), }\DataTypeTok{dimnames=}\KeywordTok{list}\NormalTok{(}\KeywordTok{levels}\NormalTok{(dg), }\KeywordTok{c}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(P),}\StringTok{"NA"}\NormalTok{)))}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{table}\NormalTok{(dg)}
  \ControlFlowTok{for}\NormalTok{(g }\ControlFlowTok{in} \KeywordTok{names}\NormalTok{(t[t}\OperatorTok{>}\DecValTok{0}\NormalTok{]))}
\NormalTok{    G[g,] <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{colSums}\NormalTok{(P[dg}\OperatorTok{==}\NormalTok{g,,}\DataTypeTok{drop=}\OtherTok{FALSE}\NormalTok{],}\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{), }\StringTok{"NA"}\NormalTok{=}\KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(P[dg}\OperatorTok{==}\NormalTok{g,}\DecValTok{1}\NormalTok{])))}
  \KeywordTok{return}\NormalTok{(G)}
\NormalTok{\}}

\NormalTok{probGenotypeTail <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
\NormalTok{  dg <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG)), }\DataTypeTok{levels=}\KeywordTok{c}\NormalTok{(}\StringTok{"NA"}\NormalTok{,}\KeywordTok{as.character}\NormalTok{(CANCERGENES)))}
\NormalTok{  P <-}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{pMutCNTail}
\NormalTok{  G <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\OtherTok{NA}\NormalTok{, }\KeywordTok{nlevels}\NormalTok{(dg))}
  \KeywordTok{names}\NormalTok{(G) <-}\StringTok{ }\KeywordTok{levels}\NormalTok{(dg)}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{table}\NormalTok{(dg)}
  \ControlFlowTok{for}\NormalTok{(g }\ControlFlowTok{in} \KeywordTok{names}\NormalTok{(t[t}\OperatorTok{>}\DecValTok{0}\NormalTok{]))}
\NormalTok{    G[g] <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(P[dg}\OperatorTok{==}\NormalTok{g,}\DataTypeTok{drop=}\OtherTok{FALSE}\NormalTok{],}\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{return}\NormalTok{(G)}
\NormalTok{\}}

\NormalTok{getGenotype <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, }\DataTypeTok{reclassify=}\StringTok{'missing'}\NormalTok{, ...)\{}
\NormalTok{  w <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\OtherTok{TRUE}\NormalTok{,}\KeywordTok{diff}\NormalTok{(}\KeywordTok{start}\NormalTok{(vcf)) }\OperatorTok{!=}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{  cls <-}\StringTok{ }\KeywordTok{classifyMutations}\NormalTok{(vcf, }\DataTypeTok{reclassify=}\NormalTok{reclassify)}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{TCN}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(t))}
\NormalTok{    t <-}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MinCN }\OperatorTok{+}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MajCN}
\NormalTok{  hom <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MutCN}\OperatorTok{==}\NormalTok{t, }\DataTypeTok{levels=}\KeywordTok{c}\NormalTok{(}\OtherTok{TRUE}\NormalTok{,}\OtherTok{FALSE}\NormalTok{))}
\NormalTok{  dg <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG), }\DataTypeTok{levels=}\KeywordTok{as.character}\NormalTok{(CANCERGENES))}
  \KeywordTok{table}\NormalTok{(}\DataTypeTok{gene=}\NormalTok{dg[w], }\DataTypeTok{class=}\NormalTok{cls[w], }\DataTypeTok{homozygous=}\NormalTok{hom[w], ...)}
\NormalTok{\}}

\NormalTok{tryExceptNull <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{class}\NormalTok{(x)}\OperatorTok{==}\StringTok{"try-error"}\NormalTok{) }\KeywordTok{GRanges}\NormalTok{() }\ControlFlowTok{else}\NormalTok{ x}

\NormalTok{loadVcf <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(vcfPath, }\DataTypeTok{pattern=}\KeywordTok{paste0}\NormalTok{(ID, }\StringTok{".+somatic.snv_mnv.TNC.vcf.bgz$"}\NormalTok{), }\DataTypeTok{full.names=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  pos <-}\StringTok{ }\KeywordTok{loadPositions}\NormalTok{(ID)}
\NormalTok{  vcf <-}\StringTok{ }\KeywordTok{readVcf}\NormalTok{(file, }\DataTypeTok{genome=}\StringTok{"GRCh37"}\NormalTok{) }\CommentTok{#, param=ScanVcfParam(which=pos))}
\NormalTok{  f <-}\StringTok{ }\KeywordTok{findOverlaps}\NormalTok{(pos, vcf, }\DataTypeTok{select=}\StringTok{"first"}\NormalTok{)}
\NormalTok{  vcf <-}\StringTok{ }\NormalTok{vcf[}\KeywordTok{na.omit}\NormalTok{(f)]}
\NormalTok{  vcf <-}\StringTok{ }\KeywordTok{addDriver}\NormalTok{(vcf, CANCERGENES)}
\NormalTok{  i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
  \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\DecValTok{1}\NormalTok{,}\DataTypeTok{Type=}\StringTok{"Numeric"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"DP cluster"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"DPC"}\NormalTok{))}
\NormalTok{  i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
  \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\DecValTok{1}\NormalTok{,}\DataTypeTok{Type=}\StringTok{"Numeric"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"DP cluster probability"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"DPP"}\NormalTok{))}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DPC <-}\StringTok{ }\NormalTok{pos}\OperatorTok{$}\NormalTok{cluster[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(f)]}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DPP <-}\StringTok{ }\NormalTok{pos}\OperatorTok{$}\NormalTok{likelihood[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(f)]    }
\NormalTok{  vcf}
\NormalTok{\}}

\NormalTok{isDeamination <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf) }\KeywordTok{grepl}\NormalTok{(}\StringTok{"(A.CG)|(T..CG)"}\NormalTok{, }\KeywordTok{paste}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{alt}\NormalTok{(vcf))),vcf}\OperatorTok{@}\NormalTok{info}\OperatorTok{$}\NormalTok{TNC))}
\NormalTok{isDeaminationNoUV <-}\StringTok{  }\ControlFlowTok{function}\NormalTok{(vcf) }\KeywordTok{grepl}\NormalTok{(}\StringTok{"(A.CG[C,T])|(T.[A,G]CG)"}\NormalTok{, }\KeywordTok{paste}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{alt}\NormalTok{(vcf))),vcf}\OperatorTok{@}\NormalTok{info}\OperatorTok{$}\NormalTok{TNC))}


\NormalTok{testDriver <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf) }\KeywordTok{sapply}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{VC, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OtherTok{FALSE}  \ControlFlowTok{else} \KeywordTok{any}\NormalTok{(x }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{'nonsense'}\NormalTok{,}\StringTok{'missense'}\NormalTok{,}\StringTok{'ess_splice'}\NormalTok{,}\StringTok{'frameshift'}\NormalTok{,}\StringTok{'inframe'}\NormalTok{,}\StringTok{'cds_distrupted'}\NormalTok{)))}

\NormalTok{addDriver <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, mutsigDrivers)\{}
\NormalTok{  i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
  \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\DecValTok{1}\NormalTok{,}\DataTypeTok{Type=}\StringTok{"String"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"Driver gene"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"DG"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(vcf)}\OperatorTok{==}\DecValTok{0}\NormalTok{)\{}
    \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG <-}\StringTok{ }\KeywordTok{CharacterList}\NormalTok{()}
    \KeywordTok{return}\NormalTok{(vcf)}
\NormalTok{  \}}
  
\NormalTok{  r <-}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"^"}\NormalTok{,mutsigDrivers,}\StringTok{"(?=}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{|)"}\NormalTok{), }\DataTypeTok{collapse=}\StringTok{"|"}\NormalTok{)}
\NormalTok{  rowIdx <-}\StringTok{ }\KeywordTok{grepl}\NormalTok{(r, }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{VD, }\DataTypeTok{perl=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{&}\StringTok{ }\KeywordTok{testDriver}\NormalTok{(vcf)}
\NormalTok{  g <-}\StringTok{ }\KeywordTok{sapply}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{VD, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{sub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{|.+"}\NormalTok{,}\StringTok{""}\NormalTok{, x))}
\NormalTok{  d <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(rowIdx,g,}\KeywordTok{character}\NormalTok{(}\DecValTok{0}\NormalTok{))}
  \CommentTok{#d[is.na(d)] <- character(0)}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG <-}\StringTok{ }\KeywordTok{as}\NormalTok{(d,}\StringTok{"CharacterList"}\NormalTok{)}
\NormalTok{  vcf}
\NormalTok{\}}

\NormalTok{loadAssignment <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(dpPath,}\StringTok{"/"}\NormalTok{,ID,}\StringTok{"_DPoutput_1250iters_250burnin/"}\NormalTok{,ID,}\StringTok{"_DP_and_cluster_info.txt"}\NormalTok{)}
  \KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{addAssignment <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, ID)\{}
\NormalTok{  a <-}\StringTok{ }\KeywordTok{loadAssignment}\NormalTok{(ID)}
\NormalTok{  i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
  \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\KeywordTok{ncol}\NormalTok{(a),}\DataTypeTok{Type=}\StringTok{"Numeric"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"DP probability"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"DPP"}\NormalTok{))}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DPP <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(a)}
\NormalTok{  vcf}
\NormalTok{\}}

\NormalTok{loadPositions <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  file <-}\StringTok{ }\KeywordTok{gzfile}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(dpPath,}\StringTok{"/"}\NormalTok{,ID,}\StringTok{"_mutation_assignments.txt.gz"}\NormalTok{))}
\NormalTok{  tmp <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(file, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
  \CommentTok{#GRanges(tmp$chr, IRanges(tmp$start+1, tmp$end), cluster=tmp$cluster, likelihood=tmp$likelihood)}
  \KeywordTok{GRanges}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{chr, }\KeywordTok{IRanges}\NormalTok{(tmp}\OperatorTok{$}\NormalTok{pos, }\DataTypeTok{width=}\DecValTok{1}\NormalTok{), }\DataTypeTok{cluster=}\NormalTok{tmp}\OperatorTok{$}\NormalTok{cluster)}
\NormalTok{\}}

\NormalTok{tncToPyrimidine <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
\NormalTok{  a <-}\StringTok{ }\KeywordTok{unlist}\NormalTok{(}\KeywordTok{alt}\NormalTok{(vcf))}
\NormalTok{  r <-}\StringTok{ }\KeywordTok{ref}\NormalTok{(vcf)}
\NormalTok{  tnc <-}\StringTok{ }\KeywordTok{DNAStringSet}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{TNC)}
\NormalTok{  rc <-}\StringTok{ }\KeywordTok{grepl}\NormalTok{(}\StringTok{"A|G"}\NormalTok{, r)}
\NormalTok{  tnc[rc] <-}\StringTok{ }\KeywordTok{reverseComplement}\NormalTok{(tnc[rc])}
\NormalTok{  a[rc] <-}\StringTok{ }\KeywordTok{reverseComplement}\NormalTok{(a[rc])}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{substr}\NormalTok{(tnc,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\StringTok{"["}\NormalTok{,}\KeywordTok{substr}\NormalTok{(tnc,}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{), }\StringTok{">"}\NormalTok{,a, }\StringTok{"]"}\NormalTok{, }\KeywordTok{substr}\NormalTok{(tnc,}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{))}
\NormalTok{  n <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{,}\StringTok{"C"}\NormalTok{,}\StringTok{"G"}\NormalTok{,}\StringTok{"T"}\NormalTok{)}
\NormalTok{  f <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{rep}\NormalTok{(n, }\DataTypeTok{each=}\DecValTok{4}\NormalTok{), }\StringTok{"["}\NormalTok{, }\KeywordTok{rep}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{,}\StringTok{"T"}\NormalTok{), }\DataTypeTok{each=}\DecValTok{96}\OperatorTok{/}\DecValTok{2}\NormalTok{), }\StringTok{">"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\KeywordTok{rep}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{,}\StringTok{"G"}\NormalTok{,}\StringTok{"T"}\NormalTok{), }\DataTypeTok{each=}\DecValTok{48}\OperatorTok{/}\DecValTok{3}\NormalTok{), }\KeywordTok{rep}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"A"}\NormalTok{,}\StringTok{"C"}\NormalTok{,}\StringTok{"G"}\NormalTok{), }\DataTypeTok{each=}\DecValTok{48}\OperatorTok{/}\DecValTok{3}\NormalTok{)), }\StringTok{"]"}\NormalTok{, n)}
  \KeywordTok{factor}\NormalTok{(t, }\DataTypeTok{levels=}\NormalTok{f)}
\NormalTok{\} }


\NormalTok{applyPigeonHole <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ID)\{}
\NormalTok{  c <-}\StringTok{ }\KeywordTok{loadClusters}\NormalTok{(ID)}
\NormalTok{  p <-}\StringTok{ }\NormalTok{purityPloidy[ID,}\StringTok{"purity"}\NormalTok{]}
\NormalTok{  mcf <-}\StringTok{ }\NormalTok{c}\OperatorTok{$}\NormalTok{proportion}\CommentTok{#*p}
\NormalTok{  l <-}\StringTok{ }\KeywordTok{sapply}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(mcf), }\ControlFlowTok{function}\NormalTok{(i) mcf[i] }\OperatorTok{>}\StringTok{ }\KeywordTok{pmax}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\OperatorTok{-}\NormalTok{mcf))}
\NormalTok{  w <-}\StringTok{ }\KeywordTok{which}\NormalTok{(l }\OperatorTok{&}\StringTok{ }\KeywordTok{upper.tri}\NormalTok{(l), }\DataTypeTok{arr.ind=}\OtherTok{TRUE}\NormalTok{)}
  \KeywordTok{cbind}\NormalTok{(c}\OperatorTok{$}\NormalTok{cluster[w[,}\DecValTok{1}\NormalTok{]], c}\OperatorTok{$}\NormalTok{cluster[w[,}\DecValTok{2}\NormalTok{]])}
\NormalTok{\}}

\NormalTok{reduceToCoverRelations <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(rel)\{}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(rel) }\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{return}\NormalTok{(rel)}
\NormalTok{  n <-}\StringTok{ }\KeywordTok{max}\NormalTok{(rel)}
\NormalTok{  P <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\OtherTok{FALSE}\NormalTok{,n,n)}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(rel))}
\NormalTok{    P[rel[i,}\DecValTok{1}\NormalTok{],rel[i,}\DecValTok{2}\NormalTok{]] <-}\StringTok{ }\OtherTok{TRUE}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{n)\{}
\NormalTok{    q <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{    visit <-}\StringTok{ }\KeywordTok{logical}\NormalTok{(n)}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{n)}
      \ControlFlowTok{if}\NormalTok{(P[i,j])}
\NormalTok{        q <-}\StringTok{ }\KeywordTok{c}\NormalTok{(q,j)}
    \ControlFlowTok{while}\NormalTok{(}\KeywordTok{length}\NormalTok{(q)}\OperatorTok{>}\DecValTok{0}\NormalTok{)\{}
\NormalTok{      j <-}\StringTok{ }\NormalTok{q[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{      q[[}\DecValTok{1}\NormalTok{]] <-}\StringTok{ }\OtherTok{NULL}
      \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{n)\{}
        \ControlFlowTok{if}\NormalTok{(P[j,k] }\OperatorTok{&}\StringTok{ }\OperatorTok{!}\NormalTok{visit[k])\{}
\NormalTok{          visit[k] <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{          q <-}\StringTok{ }\KeywordTok{c}\NormalTok{(q,k)}
          \ControlFlowTok{if}\NormalTok{(P[i,k])}
\NormalTok{            P[i,k] <-}\StringTok{ }\OtherTok{FALSE}
          \ControlFlowTok{if}\NormalTok{(P[k,i])}
            \KeywordTok{stop}\NormalTok{(}\StringTok{"Error."}\NormalTok{)}
          
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
  \KeywordTok{which}\NormalTok{(P, }\DataTypeTok{arr.ind=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\NormalTok{cnWeights <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
\NormalTok{  t <-}\StringTok{ }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{is.null}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{TCN)) (}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MajCN }\OperatorTok{+}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MinCN) }\ControlFlowTok{else} \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{TCN}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{MutCN }\OperatorTok{/}\StringTok{ }\NormalTok{t}
\NormalTok{\}}

\NormalTok{branchLengths <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, }\DataTypeTok{type=}\KeywordTok{c}\NormalTok{(}\StringTok{"all"}\NormalTok{,}\StringTok{"deamination"}\NormalTok{))\{}
\NormalTok{  type <-}\StringTok{ }\KeywordTok{match.arg}\NormalTok{(type)}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"deamination"}\NormalTok{)}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{isDeamination}\NormalTok{(vcf)}
  \ControlFlowTok{else}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\OtherTok{TRUE}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(vcf))}
\NormalTok{  cnw <-}\StringTok{ }\KeywordTok{cnWeights}\NormalTok{(vcf)}
\NormalTok{  u <-}\StringTok{ }\NormalTok{allClusters[[}\KeywordTok{meta}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))}\OperatorTok{$}\NormalTok{META[}\StringTok{"ID"}\NormalTok{,}\DecValTok{1}\NormalTok{]]]}\OperatorTok{$}\NormalTok{cluster}
\NormalTok{  b <-}\StringTok{ }\KeywordTok{sapply}\NormalTok{(u, }\ControlFlowTok{function}\NormalTok{(c) }\KeywordTok{sum}\NormalTok{(}\DecValTok{2}\OperatorTok{*}\NormalTok{cnw }\OperatorTok{*}\StringTok{ }\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DPC}\OperatorTok{==}\NormalTok{c }\OperatorTok{&}\StringTok{ }\NormalTok{w), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{))}
  \CommentTok{#if(length(b)==0) b <- rep(0, length(u))}
  \KeywordTok{names}\NormalTok{(b) <-}\StringTok{ }\NormalTok{u}
  \KeywordTok{return}\NormalTok{(b)}
\NormalTok{\}}

\NormalTok{avgWeights <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, }\DataTypeTok{type=}\KeywordTok{c}\NormalTok{(}\StringTok{"all"}\NormalTok{,}\StringTok{"deamination"}\NormalTok{))\{}
\NormalTok{  type <-}\StringTok{ }\KeywordTok{match.arg}\NormalTok{(type)}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"deamination"}\NormalTok{)}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{isDeamination}\NormalTok{(vcf)}
  \ControlFlowTok{else}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\OtherTok{TRUE}\NormalTok{, }\KeywordTok{nrow}\NormalTok{(vcf))}
\NormalTok{  cnw <-}\StringTok{ }\KeywordTok{cnWeights}\NormalTok{(vcf)}
  \KeywordTok{mean}\NormalTok{(}\DecValTok{2}\OperatorTok{*}\NormalTok{cnw[w], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\NormalTok{predictRealTime <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x, }\DataTypeTok{signatures=}\NormalTok{snmf}\OperatorTok{$}\NormalTok{snmfFit}\OperatorTok{$}\NormalTok{P[}\OperatorTok{-}\DecValTok{1}\NormalTok{,])\{}
\NormalTok{  snmf}\OperatorTok{$}\NormalTok{snmfFit}\OperatorTok{$}\NormalTok{P[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{] }\OperatorTok{/}\StringTok{ }\NormalTok{snmf}\OperatorTok{$}\NormalTok{weight }\OperatorTok{*}\StringTok{ }\NormalTok{snmf}\OperatorTok{$}\KeywordTok{nmSolve}\NormalTok{(x, signatures, }\DataTypeTok{maxIter=}\DecValTok{100}\NormalTok{)[}\DecValTok{1}\NormalTok{,]}
\NormalTok{\}}

\CommentTok{#' }\AlertTok{###}\CommentTok{ Compute graphs (posets)}
\NormalTok{toGraph <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(edgelist, branch.length, edge.labels, }\DataTypeTok{node.labels=}\DecValTok{1}\OperatorTok{:}\KeywordTok{max}\NormalTok{(edgelist))\{}
\NormalTok{  g <-}\StringTok{ }\KeywordTok{graph.edgelist}\NormalTok{(edgelist)}
  \KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{weight <-}\StringTok{ }\NormalTok{branch.length}
  \KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{name <-}\StringTok{ }\NormalTok{edge.labels}
  \KeywordTok{V}\NormalTok{(g)}\OperatorTok{$}\NormalTok{name <-}\StringTok{ }\NormalTok{node.labels}
  \KeywordTok{return}\NormalTok{(g) }
\NormalTok{\}}

\NormalTok{na.rm <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) x[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(x)]}

\NormalTok{plotPoset <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(g)\{}
\NormalTok{  c <-}\StringTok{ }\KeywordTok{colorRampPalette}\NormalTok{(}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{9}\NormalTok{, }\StringTok{"Spectral"}\NormalTok{))(}\DecValTok{10}\NormalTok{)}
  \KeywordTok{plot}\NormalTok{(g, }\DataTypeTok{layout=}\KeywordTok{layout.reingold.tilford}\NormalTok{(g), }\DataTypeTok{edge.label=}\KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{name, }\DataTypeTok{vertex.size =} \DecValTok{25}\OperatorTok{*}\KeywordTok{pmin}\NormalTok{(}\DecValTok{1}\NormalTok{,}\KeywordTok{V}\NormalTok{(g)}\OperatorTok{$}\NormalTok{size), }\DataTypeTok{edge.width=}\KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{weight}\OperatorTok{/}\DecValTok{100}\NormalTok{)}
\NormalTok{\}}

\CommentTok{#' Distance in poset        }
\NormalTok{posetDist <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(g) \{}
\NormalTok{  e <-}\StringTok{ }\KeywordTok{get.edgelist}\NormalTok{(g)}
\NormalTok{  w <-}\StringTok{  }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{weight)}
  \KeywordTok{names}\NormalTok{(w) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Germline"}\NormalTok{, e[,}\DecValTok{2}\NormalTok{])}
\NormalTok{  d <-}\StringTok{ }\KeywordTok{shortest.paths}\NormalTok{(g, }\DataTypeTok{mode=}\StringTok{'out'}\NormalTok{)}
\NormalTok{  d <-}\StringTok{ }\NormalTok{d }\OperatorTok{-}\StringTok{ }\KeywordTok{rep}\NormalTok{(w[}\KeywordTok{colnames}\NormalTok{(d)], }\DataTypeTok{each=}\KeywordTok{length}\NormalTok{(w))}\OperatorTok{/}\DecValTok{2}
  \KeywordTok{diag}\NormalTok{(d) <-}\StringTok{ }\OtherTok{NA}
\NormalTok{  d}
\NormalTok{\}}

\NormalTok{getMutationCluster <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(allMutations, vcf)\{}
\NormalTok{  m <-}\StringTok{ }\KeywordTok{match}\NormalTok{(allMutations, }\KeywordTok{unlist}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG))}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DPC[m]}
\NormalTok{\}}

\NormalTok{distAsRange <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(g)\{}
\NormalTok{  e <-}\StringTok{ }\KeywordTok{get.edgelist}\NormalTok{(g)}
\NormalTok{  w <-}\StringTok{  }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{weight)}
  \KeywordTok{names}\NormalTok{(w) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Germline"}\NormalTok{, e[,}\DecValTok{2}\NormalTok{])}
\NormalTok{  d <-}\StringTok{ }\KeywordTok{shortest.paths}\NormalTok{(g, }\DataTypeTok{mode=}\StringTok{'out'}\NormalTok{)}
\NormalTok{  y <-}\StringTok{ }\KeywordTok{shift}\NormalTok{(}\KeywordTok{IRanges}\NormalTok{(}\OperatorTok{-}\NormalTok{w[}\KeywordTok{colnames}\NormalTok{(d)],}\DecValTok{0}\NormalTok{), d[}\StringTok{"Germline"}\NormalTok{, ])}
  \KeywordTok{names}\NormalTok{(y) <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(d), }\StringTok{", genes="}\NormalTok{,}\KeywordTok{E}\NormalTok{(g)}\OperatorTok{$}\NormalTok{name[}\KeywordTok{match}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(d), e[,}\DecValTok{2}\NormalTok{])])}
\NormalTok{  y}
\NormalTok{\}}


\NormalTok{nmSolve <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(D, P, }\DataTypeTok{maxIter =} \DecValTok{500}\NormalTok{, }\DataTypeTok{tol=}\FloatTok{1e-3}\NormalTok{) \{}
\NormalTok{  n <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(D)}
\NormalTok{  m <-}\StringTok{ }\KeywordTok{ncol}\NormalTok{(D)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{ncol}\NormalTok{(P)}
\NormalTok{  tP <-}\StringTok{ }\KeywordTok{t}\NormalTok{(P)}
\NormalTok{  rP <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\KeywordTok{colSums}\NormalTok{(P), m)}
\NormalTok{  D <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(D)}
\NormalTok{  E1 <-}\StringTok{ }\NormalTok{E2 <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\KeywordTok{runif}\NormalTok{(s }\OperatorTok{*}\StringTok{ }\NormalTok{m, }\FloatTok{1e-3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\DataTypeTok{ncol =}\NormalTok{ m)}
\NormalTok{  err <-}\StringTok{ }\DecValTok{2}\OperatorTok{*}\NormalTok{tol}
  
\NormalTok{  iter <-}\StringTok{ }\DecValTok{1}
  \ControlFlowTok{while}\NormalTok{ (iter }\OperatorTok{<}\StringTok{ }\NormalTok{maxIter }\OperatorTok{&}\StringTok{ }\NormalTok{err }\OperatorTok{>}\StringTok{ }\NormalTok{tol) \{}
\NormalTok{    E1 <-}\StringTok{ }\NormalTok{E2}
\NormalTok{    E2 <-}\StringTok{ }\NormalTok{E1 }\OperatorTok{*}\StringTok{ }\NormalTok{(tP }\OperatorTok{%*%}\StringTok{ }\NormalTok{(D}\OperatorTok{/}\NormalTok{(P }\OperatorTok{%*%}\StringTok{ }\NormalTok{(E1 }\OperatorTok{+}\StringTok{ }\NormalTok{.Machine}\OperatorTok{$}\NormalTok{double.eps))))}\OperatorTok{/}\NormalTok{rP}
\NormalTok{    iter <-}\StringTok{ }\NormalTok{iter }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{    err <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(}\KeywordTok{abs}\NormalTok{(E2 }\OperatorTok{-}\StringTok{ }\NormalTok{E1)}\OperatorTok{/}\NormalTok{(E1}\OperatorTok{+}\NormalTok{.Machine}\OperatorTok{$}\NormalTok{double.eps), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(iter }\OperatorTok{%%}\StringTok{ }\DecValTok{100} \OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{cat}\NormalTok{(}\KeywordTok{round}\NormalTok{(}\OperatorTok{-}\KeywordTok{log10}\NormalTok{(err)))}
\NormalTok{  \}}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(iter }\OperatorTok{==}\StringTok{ }\NormalTok{maxIter) }\KeywordTok{warning}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"No convergence after"}\NormalTok{,iter, }\StringTok{"iterations."}\NormalTok{))}
\NormalTok{  E2}
\NormalTok{\}}

\NormalTok{wnmSolve <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(D, P, }\DataTypeTok{weights =}  \KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{ncol}\NormalTok{(P)), }\DataTypeTok{maxIter =} \DecValTok{500}\NormalTok{, }\DataTypeTok{tol=}\FloatTok{1e-3}\NormalTok{) \{}
\NormalTok{  D <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(D)}
\NormalTok{  D <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(D, }\KeywordTok{matrix}\NormalTok{(weights, }\DataTypeTok{ncol=}\KeywordTok{ncol}\NormalTok{(D), }\DataTypeTok{nrow=}\KeywordTok{ncol}\NormalTok{(P)))}
\NormalTok{  P <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(P, }\KeywordTok{diag}\NormalTok{(}\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\KeywordTok{ncol}\NormalTok{(P))))}
\NormalTok{  n <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(D)}
\NormalTok{  m <-}\StringTok{ }\KeywordTok{ncol}\NormalTok{(D)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{ncol}\NormalTok{(P)}
\NormalTok{  tP <-}\StringTok{ }\KeywordTok{t}\NormalTok{(P)}
\NormalTok{  rP <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\KeywordTok{colSums}\NormalTok{(P), m)}
\NormalTok{  E1 <-}\StringTok{ }\NormalTok{E2 <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\KeywordTok{runif}\NormalTok{(s }\OperatorTok{*}\StringTok{ }\NormalTok{m, }\FloatTok{1e-3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\DataTypeTok{ncol =}\NormalTok{ m)}
\NormalTok{  err <-}\StringTok{ }\DecValTok{2}\OperatorTok{*}\NormalTok{tol}
  
\NormalTok{  iter <-}\StringTok{ }\DecValTok{1}
  \ControlFlowTok{while}\NormalTok{ (iter }\OperatorTok{<}\StringTok{ }\NormalTok{maxIter }\OperatorTok{&}\StringTok{ }\NormalTok{err }\OperatorTok{>}\StringTok{ }\NormalTok{tol) \{}
\NormalTok{    E1 <-}\StringTok{ }\NormalTok{E2}
\NormalTok{    E2 <-}\StringTok{ }\NormalTok{E1 }\OperatorTok{*}\StringTok{ }\NormalTok{(tP }\OperatorTok{%*%}\StringTok{ }\NormalTok{(D}\OperatorTok{/}\NormalTok{(P }\OperatorTok{%*%}\StringTok{ }\NormalTok{(E1 }\OperatorTok{+}\StringTok{ }\NormalTok{.Machine}\OperatorTok{$}\NormalTok{double.eps))))}\OperatorTok{/}\NormalTok{rP}
\NormalTok{    iter <-}\StringTok{ }\NormalTok{iter }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{    err <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(}\KeywordTok{abs}\NormalTok{(E2 }\OperatorTok{-}\StringTok{ }\NormalTok{E1)}\OperatorTok{/}\NormalTok{(E1}\OperatorTok{+}\NormalTok{.Machine}\OperatorTok{$}\NormalTok{double.eps), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(iter }\OperatorTok{%%}\StringTok{ }\DecValTok{100} \OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) }\KeywordTok{cat}\NormalTok{(}\KeywordTok{round}\NormalTok{(}\OperatorTok{-}\KeywordTok{log10}\NormalTok{(err)))}
\NormalTok{  \}}
  \KeywordTok{cat}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(iter }\OperatorTok{==}\StringTok{ }\NormalTok{maxIter) }\KeywordTok{warning}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"No convergence after"}\NormalTok{,iter, }\StringTok{"iterations."}\NormalTok{))}
\NormalTok{  E2}
\NormalTok{\}}



\NormalTok{wgdTest <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf)\{}
\NormalTok{  id <-}\StringTok{ }\KeywordTok{meta}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))}\OperatorTok{$}\NormalTok{META[}\StringTok{"ID"}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  bb <-}\StringTok{ }\NormalTok{allBB[[id]]}
\NormalTok{  ix <-}\StringTok{ }\KeywordTok{which}\NormalTok{(bb}\OperatorTok{$}\NormalTok{copy_number}\OperatorTok{==}\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{minor_cn}\OperatorTok{==}\DecValTok{2}\NormalTok{)}
\NormalTok{  v <-}\StringTok{ }\NormalTok{vcf[vcf }\OperatorTok{%over%}\StringTok{ }\NormalTok{bb[ix]]}
  \CommentTok{#w <- sum(as.numeric(width(reduce(bb[ix]))))}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{table}\NormalTok{(}\KeywordTok{info}\NormalTok{(v)}\OperatorTok{$}\NormalTok{MutCN, }\KeywordTok{info}\NormalTok{(v)}\OperatorTok{$}\NormalTok{TCN, }\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(v)), }\KeywordTok{info}\NormalTok{(v)}\OperatorTok{$}\NormalTok{DPC)}
\NormalTok{\}}

\CommentTok{#' Power}
\NormalTok{power <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(f,n, }\DataTypeTok{theta=}\FloatTok{6.3}\NormalTok{, }\DataTypeTok{err=}\FloatTok{1e-4}\NormalTok{) }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(}\KeywordTok{c}\NormalTok{(f,n,theta,err)))) }\OtherTok{NA} \ControlFlowTok{else} \KeywordTok{sum}\NormalTok{((}\KeywordTok{log10}\NormalTok{(}\KeywordTok{dbinom}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{n, n, }\DecValTok{0}\OperatorTok{:}\NormalTok{n}\OperatorTok{/}\NormalTok{n) }\OperatorTok{/}\StringTok{ }\KeywordTok{dbinom}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{n,n,err)) }\OperatorTok{>}\StringTok{ }\NormalTok{theta) }\OperatorTok{*}\StringTok{ }\KeywordTok{dbinom}\NormalTok{(}\DecValTok{0}\OperatorTok{:}\NormalTok{n,n,f))}

\NormalTok{testIndel <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf) }\KeywordTok{sapply}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{VC, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{(}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OtherTok{FALSE}  \ControlFlowTok{else} \KeywordTok{any}\NormalTok{(x }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{'frameshift'}\NormalTok{,}\StringTok{'inframe'}\NormalTok{,}\StringTok{'ess_splice'}\NormalTok{,}\StringTok{'SO:0001577:complex_change_in_transcript'}\NormalTok{, }\StringTok{'SO:0001582:initiator_codon_change'}\NormalTok{, }\StringTok{'splice_region'}\NormalTok{)))}

\NormalTok{asum <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x, dim) }\KeywordTok{apply}\NormalTok{(x, }\KeywordTok{setdiff}\NormalTok{(}\KeywordTok{seq_along}\NormalTok{(}\KeywordTok{dim}\NormalTok{(x)), dim), sum)}

\CommentTok{#' official driver file}
\CommentTok{#d <- lapply(2:3, function(sheet) xlsx::read.xlsx2(file="~/pcawg/ref/TableS2_driver_point_mutations_annotation.xlsx", sheetIndex=sheet, colIndex=1:22, stringsAsFactors=FALSE, na.char="NaN"))}
\CommentTok{#colnames(d[[2]]) <- colnames(d[[1]])}
\CommentTok{#drivers <- do.call("rbind",d)}
\CommentTok{#drivers[drivers=="NaN" | drivers==""] <- NA}
\CommentTok{#drivers <- as.data.frame(sapply(drivers, function(x) if(all(!is.na(as.numeric(x[!is.na(x)])))) as.numeric(x) else x, simplify=FALSE))}
\NormalTok{finalData <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"~/pcawg/final/ref/release_may2016.v1.4.tsv"}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\CommentTok{#r <- gsub("-","",drivers$ref)}
\CommentTok{#i <- grepl("-",drivers$ref) | grepl("-",drivers$alt)  #drivers$mut_type=="indel" # need to fix indels}
\CommentTok{#r[i] <- paste0("N",r[i])}
\CommentTok{#a <- gsub("-","",drivers$alt)}
\CommentTok{#a[i] <- paste0("N",a[i])}
\CommentTok{#p <- drivers$pos}
\CommentTok{#p[i & !grepl("-", drivers$ref)] <- p[i & !grepl("-", drivers$ref)]-1}
\CommentTok{#m <- sapply(levels(drivers$sample), function(x) grep(x, finalData$sanger_variant_calling_file_name_prefix))}
\CommentTok{#finalDrivers <- VRanges(seqnames = drivers$chr, ranges=IRanges(p, width =  width(r)), ref=DNAStringSet(r), alt=DNAStringSet(a), sampleNames = finalData$icgc_donor_id[m[drivers$sample]])}
\CommentTok{#mcols(finalDrivers) <- cbind(sample=drivers$sample, samples=finalData$sanger_variant_calling_file_name_prefix[m[drivers$sample]], ID= drivers$gene_id, drivers[,8:22], mut_type=ifelse(i, "indel","snv"))}
\CommentTok{#save(finalDrivers, file="~/pcawg/ref/TableS2_driver_point_mutations_annotation.RData")}
\KeywordTok{load}\NormalTok{(}\DataTypeTok{file=}\StringTok{"~/pcawg/ref/TableS2_driver_point_mutations_annotation.RData"}\NormalTok{)}
\NormalTok{CANCERGENES <-}\StringTok{ }\KeywordTok{levels}\NormalTok{(finalDrivers}\OperatorTok{$}\NormalTok{ID)}

\NormalTok{matchDrivers <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, finalDrivers) \{}
\NormalTok{  ID <-}\StringTok{ }\KeywordTok{meta}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))}\OperatorTok{$}\NormalTok{META[}\StringTok{"ID"}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d <-}\StringTok{ }\NormalTok{finalDrivers[}\KeywordTok{grep}\NormalTok{(ID, finalDrivers}\OperatorTok{$}\NormalTok{samples)]}
\NormalTok{  g <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{rep}\NormalTok{(}\OtherTok{NA}\NormalTok{,}\KeywordTok{nrow}\NormalTok{(vcf)), }\DataTypeTok{levels =} \KeywordTok{levels}\NormalTok{(d}\OperatorTok{$}\NormalTok{ID))}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{length}\NormalTok{(d)}\OperatorTok{==}\DecValTok{0}\NormalTok{)}
    \KeywordTok{return}\NormalTok{(g)}
\NormalTok{  overlaps <-}\StringTok{ }\KeywordTok{findOverlaps}\NormalTok{(vcf, d)}
\NormalTok{  g[}\KeywordTok{queryHits}\NormalTok{(overlaps)] <-}\StringTok{ }\NormalTok{d}\OperatorTok{$}\NormalTok{ID[}\KeywordTok{subjectHits}\NormalTok{(overlaps)]}
  \KeywordTok{return}\NormalTok{(g)}
\NormalTok{\}}

\NormalTok{addFinalDriver <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, finalDrivers)\{}
\NormalTok{  i =}\StringTok{ }\KeywordTok{header}\NormalTok{(vcf)}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO}
  \KeywordTok{exptData}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{header}\OperatorTok{@}\NormalTok{header}\OperatorTok{$}\NormalTok{INFO <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(i, }\KeywordTok{DataFrame}\NormalTok{(}\DataTypeTok{Number=}\DecValTok{1}\NormalTok{,}\DataTypeTok{Type=}\StringTok{"String"}\NormalTok{,}\DataTypeTok{Description=}\StringTok{"Driver mutation"}\NormalTok{, }\DataTypeTok{row.names=}\StringTok{"DG"}\NormalTok{))}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{rep}\NormalTok{(}\OtherTok{NA}\NormalTok{,}\KeywordTok{nrow}\NormalTok{(vcf)), }\DataTypeTok{levels =} \KeywordTok{levels}\NormalTok{(finalDrivers}\OperatorTok{$}\NormalTok{ID))}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(vcf)}\OperatorTok{==}\DecValTok{0}\NormalTok{)}
    \KeywordTok{return}\NormalTok{(vcf)}
\NormalTok{  g <-}\StringTok{ }\KeywordTok{matchDrivers}\NormalTok{(}\DataTypeTok{vcf =}\NormalTok{ vcf, }\DataTypeTok{finalDrivers =}\NormalTok{ finalDrivers)}
  \KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{DG <-}\StringTok{ }\NormalTok{g}
  \KeywordTok{return}\NormalTok{(vcf)}
\NormalTok{\}}


\NormalTok{clinicalData <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"../ref/pcawg_donor_clinical_August2016_v9.tsv"}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\DataTypeTok{comment=}\StringTok{""}\NormalTok{, }\DataTypeTok{quote=}\StringTok{""}\NormalTok{)}

\KeywordTok{load}\NormalTok{(}\StringTok{"../ref/Sarcs_ages.RDa"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(x }\ControlFlowTok{in}\NormalTok{ Sarcs_age)}
\NormalTok{  clinicalData}\OperatorTok{$}\NormalTok{donor_age_at_diagnosis[}\KeywordTok{match}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(x}\OperatorTok{$}\NormalTok{icgc_donor_id), }\KeywordTok{as.character}\NormalTok{(clinicalData}\OperatorTok{$}\NormalTok{icgc_donor_id))] <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(x}\OperatorTok{$}\NormalTok{Age)}
\KeywordTok{rm}\NormalTok{(Sarcs_age)}
\NormalTok{specimenData <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"../ref/pcawg_specimen_histology_August2016_v9.tsv"}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\DataTypeTok{comment=}\StringTok{""}\NormalTok{, }\DataTypeTok{quote=}\StringTok{""}\NormalTok{)}
\NormalTok{specimenData}\OperatorTok{$}\NormalTok{histology_abbreviation <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"CA$"}\NormalTok{,}\StringTok{"Ca"}\NormalTok{,specimenData}\OperatorTok{$}\NormalTok{histology_abbreviation)}

\NormalTok{s <-}\StringTok{ }\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(finalData}\OperatorTok{$}\NormalTok{sanger_variant_calling_file_name_prefix),}\StringTok{","}\NormalTok{)}
\NormalTok{sample2donor <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(finalData}\OperatorTok{$}\NormalTok{icgc_donor_id[}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{sapply}\NormalTok{(}\KeywordTok{seq_along}\NormalTok{(s), }\ControlFlowTok{function}\NormalTok{(i) }\KeywordTok{rep}\NormalTok{(i, }\KeywordTok{length}\NormalTok{(s[[i]]))))])}
\KeywordTok{names}\NormalTok{(sample2donor) <-}\StringTok{ }\KeywordTok{unlist}\NormalTok{(s)}

\NormalTok{s <-}\StringTok{ }\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(finalData}\OperatorTok{$}\NormalTok{sanger_variant_calling_file_name_prefix),}\StringTok{","}\NormalTok{)}
\NormalTok{sample2icgc <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(finalData}\OperatorTok{$}\NormalTok{tumor_wgs_icgc_sample_id[}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{sapply}\NormalTok{(}\KeywordTok{seq_along}\NormalTok{(s), }\ControlFlowTok{function}\NormalTok{(i) }\KeywordTok{rep}\NormalTok{(i, }\KeywordTok{length}\NormalTok{(s[[i]]))))])}
\KeywordTok{names}\NormalTok{(sample2icgc) <-}\StringTok{ }\KeywordTok{unlist}\NormalTok{(s)}


\NormalTok{donor2type <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(specimenData}\OperatorTok{$}\NormalTok{histology_abbreviation, }\DataTypeTok{levels=}\KeywordTok{c}\NormalTok{(}\KeywordTok{sort}\NormalTok{(}\KeywordTok{unique}\NormalTok{(specimenData}\OperatorTok{$}\NormalTok{histology_abbreviation))[}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\StringTok{""}\NormalTok{))}
\KeywordTok{names}\NormalTok{(donor2type) <-}\StringTok{ }\NormalTok{specimenData}\OperatorTok{$}\NormalTok{icgc_donor_id}
\KeywordTok{levels}\NormalTok{(donor2type)[}\KeywordTok{levels}\NormalTok{(donor2type)}\OperatorTok{==}\StringTok{""}\NormalTok{] <-}\StringTok{ "Other/NA"}


\NormalTok{t <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"../ref/tumour_subtype_consolidation_map.tsv - Unique List of Tumour Types_August.tsv"}\NormalTok{, }\DataTypeTok{sep=}\StringTok{'}\CharTok{\textbackslash{}t}\StringTok{'}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{comment=}\StringTok{""}\NormalTok{)}
\NormalTok{c <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(t}\OperatorTok{$}\StringTok{`}\DataTypeTok{Color..RGB.code.}\StringTok{`}\NormalTok{)}
\KeywordTok{names}\NormalTok{(c) <-}\StringTok{ }\KeywordTok{sub}\NormalTok{(}\StringTok{"CA$"}\NormalTok{,}\StringTok{"Ca"}\NormalTok{,t}\OperatorTok{$}\StringTok{`}\DataTypeTok{Abbreviation}\StringTok{`}\NormalTok{)}
\NormalTok{c <-}\StringTok{ }\NormalTok{c[c }\OperatorTok{!=}\StringTok{ ""}  \OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{duplicated}\NormalTok{(}\KeywordTok{names}\NormalTok{(c))]}
\NormalTok{tissueColors <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{table}\NormalTok{(donor2type))}\OperatorTok{*}\OtherTok{NA}
\NormalTok{tissueColors[}\KeywordTok{names}\NormalTok{(c)] <-}\StringTok{ }\NormalTok{c}
\NormalTok{tissueColors[}\StringTok{"Lymph-CLL"}\NormalTok{] <-}\StringTok{ "#F4A35D"}

\NormalTok{tissueBorder <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"white"}\NormalTok{,}\StringTok{"black"}\NormalTok{)[}\KeywordTok{names}\NormalTok{(tissueColors) }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Lung-SCC"}\NormalTok{,}\StringTok{"Lung-AdenoCa"}\NormalTok{)}\OperatorTok{+}\DecValTok{1}\NormalTok{]}
\KeywordTok{names}\NormalTok{(tissueBorder) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(tissueColors)}

\NormalTok{tissueLines <-}\StringTok{ }\NormalTok{tissueColors}
\NormalTok{tissueLines[}\KeywordTok{names}\NormalTok{(tissueColors) }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Lung-SCC"}\NormalTok{,}\StringTok{"Lung-AdenoCa"}\NormalTok{)] <-}\StringTok{ "black"}

\NormalTok{tissueLty <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)[}\KeywordTok{names}\NormalTok{(tissueColors) }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Lung-SCC"}\NormalTok{,}\StringTok{"Lung-AdenoCa"}\NormalTok{)}\OperatorTok{+}\DecValTok{1}\NormalTok{]}
\KeywordTok{names}\NormalTok{(tissueLty) <-}\StringTok{ }\KeywordTok{names}\NormalTok{(tissueColors)}
\NormalTok{tissueLty[}\StringTok{"Lung-SCC"}\NormalTok{] <-}\StringTok{ }\DecValTok{5}
\NormalTok{tissueLty[}\StringTok{"Lung-AdenoCa"}\NormalTok{] <-}\StringTok{ }\DecValTok{4}

\NormalTok{tissueCex <-}\StringTok{ }\NormalTok{tissueLty}
\NormalTok{tissueCex[}\KeywordTok{grep}\NormalTok{(}\StringTok{"Lung"}\NormalTok{, }\KeywordTok{names}\NormalTok{(tissueCex))] <-}\StringTok{ }\FloatTok{0.8}

\NormalTok{averageHom <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb)\{}
  \KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{(bb}\OperatorTok{$}\NormalTok{minor_cn }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{) }\OperatorTok{/}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb) }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{\}}

\NormalTok{.classWgd <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(ploidy, hom) }\FloatTok{2.9} \OperatorTok{-}\DecValTok{2}\OperatorTok{*}\NormalTok{hom }\OperatorTok{<=}\StringTok{ }\NormalTok{ploidy}

\NormalTok{classWgd <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb) }\KeywordTok{.classWgd}\NormalTok{(}\KeywordTok{averagePloidy}\NormalTok{(bb), }\KeywordTok{averageHom}\NormalTok{(bb))}

\NormalTok{plotBB <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb, }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\KeywordTok{max}\NormalTok{(}\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{total_cn, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{))), }\DataTypeTok{col=}\NormalTok{RColorBrewer}\OperatorTok{::}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{4}\NormalTok{,}\StringTok{"Set2"}\NormalTok{), }\DataTypeTok{type=}\KeywordTok{c}\NormalTok{(}\StringTok{"lines"}\NormalTok{,}\StringTok{"bars"}\NormalTok{), }\DataTypeTok{legend=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lty.grid=}\DecValTok{1}\NormalTok{, }\DataTypeTok{col.grid=}\StringTok{"grey"}\NormalTok{, }\DataTypeTok{xaxt=}\OtherTok{TRUE}\NormalTok{)\{}
\NormalTok{  type <-}\StringTok{ }\KeywordTok{match.arg}\NormalTok{(type)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{22}\NormalTok{, }\StringTok{"X"}\NormalTok{,}\StringTok{"Y"}\NormalTok{)}
\NormalTok{  l <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(refLengths[}\KeywordTok{seqnames}\NormalTok{(refLengths) }\OperatorTok{%in%}\StringTok{ }\NormalTok{s]))}
  \KeywordTok{names}\NormalTok{(l) <-}\StringTok{ }\NormalTok{s}
  \KeywordTok{plot}\NormalTok{(}\OtherTok{NA}\NormalTok{,}\OtherTok{NA}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Copy number"}\NormalTok{,}\DataTypeTok{xlab=}\StringTok{""}\NormalTok{,}\DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\KeywordTok{sum}\NormalTok{(l)), }\DataTypeTok{ylim=}\NormalTok{ylim, }\DataTypeTok{xaxt=}\StringTok{"n"}\NormalTok{)}
\NormalTok{  c <-}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)}
  \KeywordTok{axis}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,c), }\DataTypeTok{labels=}\KeywordTok{rep}\NormalTok{(}\StringTok{''}\NormalTok{, }\KeywordTok{length}\NormalTok{(l)}\OperatorTok{+}\DecValTok{1}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{(xaxt) }\KeywordTok{mtext}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=} \KeywordTok{cumsum}\NormalTok{(l) }\OperatorTok{-}\StringTok{ }\NormalTok{l}\OperatorTok{/}\DecValTok{2}\NormalTok{, }\DataTypeTok{text=}\KeywordTok{names}\NormalTok{(l), }\DataTypeTok{line=}\DecValTok{1}\NormalTok{)}
  \CommentTok{#abline(v=c, lty=3)}
  \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"lines"}\NormalTok{)\{}
\NormalTok{    x0 <-}\StringTok{ }\KeywordTok{start}\NormalTok{(bb) }\OperatorTok{+}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb))] }\OperatorTok{-}\StringTok{ }\NormalTok{l[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb))]}
\NormalTok{    x1 <-}\StringTok{ }\KeywordTok{end}\NormalTok{(bb) }\OperatorTok{+}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb))] }\OperatorTok{-}\StringTok{ }\NormalTok{l[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb))]}
\NormalTok{    lwd <-}\StringTok{ }\DecValTok{5}\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency }\OperatorTok{/}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency)}
    \KeywordTok{segments}\NormalTok{(}\DataTypeTok{x0=}\NormalTok{x0, bb}\OperatorTok{$}\NormalTok{major_cn ,x1, bb}\OperatorTok{$}\NormalTok{major_cn, }\DataTypeTok{col=}\NormalTok{col[}\DecValTok{1}\NormalTok{], }\DataTypeTok{lwd=}\NormalTok{lwd)}
    \KeywordTok{segments}\NormalTok{(}\DataTypeTok{x0=}\NormalTok{x0, bb}\OperatorTok{$}\NormalTok{minor_cn }\OperatorTok{-}\NormalTok{.}\DecValTok{125}\NormalTok{,x1, bb}\OperatorTok{$}\NormalTok{minor_cn}\OperatorTok{-}\NormalTok{.}\DecValTok{125}\NormalTok{, }\DataTypeTok{col=}\NormalTok{col[}\DecValTok{2}\NormalTok{], }\DataTypeTok{lwd=}\NormalTok{lwd)}
    \KeywordTok{segments}\NormalTok{(}\DataTypeTok{x0=}\NormalTok{x0, bb}\OperatorTok{$}\NormalTok{total_cn}\OperatorTok{+}\NormalTok{.}\DecValTok{125}\NormalTok{,x1, bb}\OperatorTok{$}\NormalTok{total_cn}\OperatorTok{+}\NormalTok{.}\DecValTok{125}\NormalTok{, }\DataTypeTok{col=}\DecValTok{1}\NormalTok{, }\DataTypeTok{lwd=}\NormalTok{lwd)}
    \CommentTok{#   cv <- coverage(bb)}
    \CommentTok{#   cv <- cv[s[s%in%names(cv)]]}
    \CommentTok{#   par(xpd=NA)}
    \CommentTok{#   for(n in names(cv))\{}
    \CommentTok{#       cc <- cv[[n]]}
    \CommentTok{#       segments(start(cc) + cumsum(l)[n] - l[n] ,-runValue(cc)/2,end(cc)+ cumsum(l)[n] - l[n], -runValue(cc)/2, col=4)}
    \CommentTok{#   \}}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    ub <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(bb)}
\NormalTok{    f <-}\StringTok{ }\KeywordTok{findOverlaps}\NormalTok{(ub,bb)}
\NormalTok{    m <-}\StringTok{ }\KeywordTok{t}\NormalTok{(}\KeywordTok{model.matrix}\NormalTok{( }\OperatorTok{~}\StringTok{ }\DecValTok{0} \OperatorTok{+}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{queryHits}\NormalTok{(f))))}
\NormalTok{    ub}\OperatorTok{$}\NormalTok{total_cn <-}\StringTok{ }\NormalTok{m }\OperatorTok{%*%}\StringTok{ }\NormalTok{mg14}\OperatorTok{::}\KeywordTok{na.zero}\NormalTok{(bb}\OperatorTok{$}\NormalTok{total_cn }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency) }\OperatorTok{/}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency)}
\NormalTok{    ub}\OperatorTok{$}\NormalTok{major_cn <-}\StringTok{ }\NormalTok{m }\OperatorTok{%*%}\StringTok{ }\NormalTok{mg14}\OperatorTok{::}\KeywordTok{na.zero}\NormalTok{(bb}\OperatorTok{$}\NormalTok{major_cn }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency) }\OperatorTok{/}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency)}
\NormalTok{    ub}\OperatorTok{$}\NormalTok{minor_cn <-}\StringTok{ }\NormalTok{m }\OperatorTok{%*%}\StringTok{ }\NormalTok{mg14}\OperatorTok{::}\KeywordTok{na.zero}\NormalTok{(bb}\OperatorTok{$}\NormalTok{minor_cn }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{clonal_frequency) }\OperatorTok{/}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency)}
\NormalTok{    ub}\OperatorTok{$}\NormalTok{clonal_frequency <-}\StringTok{ }\KeywordTok{max}\NormalTok{(bb}\OperatorTok{$}\NormalTok{clonal_frequency)}
\NormalTok{    x0 <-}\StringTok{ }\KeywordTok{start}\NormalTok{(ub) }\OperatorTok{+}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(ub))] }\OperatorTok{-}\StringTok{ }\NormalTok{l[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(ub))]}
\NormalTok{    x1 <-}\StringTok{ }\KeywordTok{end}\NormalTok{(ub) }\OperatorTok{+}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(ub))] }\OperatorTok{-}\StringTok{ }\NormalTok{l[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(ub))]}
    \KeywordTok{rect}\NormalTok{(x0,}\DecValTok{0}\NormalTok{,x1, ub}\OperatorTok{$}\NormalTok{major_cn, }\DataTypeTok{col=}\NormalTok{col[}\DecValTok{2}\NormalTok{], }\DataTypeTok{lwd=}\OtherTok{NA}\NormalTok{)}
    \KeywordTok{rect}\NormalTok{(x0,ub}\OperatorTok{$}\NormalTok{major_cn,x1, ub}\OperatorTok{$}\NormalTok{total_cn, }\DataTypeTok{col=}\NormalTok{col[}\DecValTok{1}\NormalTok{], }\DataTypeTok{lwd=}\OtherTok{NA}\NormalTok{)}
    \KeywordTok{abline}\NormalTok{(}\DataTypeTok{h =} \DecValTok{1}\OperatorTok{:}\KeywordTok{floor}\NormalTok{(ylim[}\DecValTok{2}\NormalTok{]), }\DataTypeTok{lty=}\NormalTok{lty.grid, }\DataTypeTok{col=}\NormalTok{col.grid)}
\NormalTok{  \}}
  \KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{], }\DataTypeTok{lty=}\NormalTok{lty.grid, }\DataTypeTok{col=}\NormalTok{col.grid)}
  \ControlFlowTok{if}\NormalTok{(xaxt) }\KeywordTok{mtext}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{line=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=}\NormalTok{chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{diff}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{])}\OperatorTok{/}\DecValTok{2}\NormalTok{, }\DataTypeTok{text=}\KeywordTok{names}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{]))}
  \ControlFlowTok{if}\NormalTok{(legend)\{}
    \ControlFlowTok{if}\NormalTok{(type}\OperatorTok{==}\StringTok{"lines"}\NormalTok{) }\KeywordTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\StringTok{"Total CN"}\NormalTok{,}\StringTok{"Major CN"}\NormalTok{,}\StringTok{"Minor CN"}\NormalTok{), }\DataTypeTok{col=}\KeywordTok{c}\NormalTok{(}\StringTok{"black"}\NormalTok{, col[}\DecValTok{1}\OperatorTok{:}\DecValTok{2}\NormalTok{]), }\DataTypeTok{lty=}\DecValTok{1}\NormalTok{, }\DataTypeTok{lwd=}\DecValTok{2}\NormalTok{, }\DataTypeTok{bg=}\StringTok{'white'}\NormalTok{)}
    \ControlFlowTok{else} \KeywordTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\StringTok{"Major CN"}\NormalTok{,}\StringTok{"Minor CN"}\NormalTok{), }\DataTypeTok{fill=}\NormalTok{col[}\DecValTok{1}\OperatorTok{:}\DecValTok{2}\NormalTok{], }\DataTypeTok{bg=}\StringTok{'white'}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{plotVcf <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(vcf, bb, clusters, }\DataTypeTok{col =}\NormalTok{ RColorBrewer}\OperatorTok{::}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{9}\NormalTok{, }\StringTok{"Set1"}\NormalTok{)[}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{9}\NormalTok{)], }\DataTypeTok{ID =} \KeywordTok{meta}\NormalTok{(}\KeywordTok{header}\NormalTok{(vcf))[[}\DecValTok{1}\NormalTok{]][}\StringTok{"ID"}\NormalTok{,}\DecValTok{1}\NormalTok{], }\DataTypeTok{IS_WGD=}\KeywordTok{classWgd}\NormalTok{(bb), }\DataTypeTok{NO_CLUSTER=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{title=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{lty.grid=}\DecValTok{1}\NormalTok{, }\DataTypeTok{col.grid=}\StringTok{"grey"}\NormalTok{, }\DataTypeTok{xaxt=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{16}\NormalTok{, }\DataTypeTok{pch.out=}\NormalTok{pch, }\DataTypeTok{cex=}\FloatTok{0.66}\NormalTok{) \{}
\NormalTok{  cls <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{CLS)), }\DataTypeTok{levels =} \KeywordTok{c}\NormalTok{(}\KeywordTok{levels}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{CLS), }\StringTok{"NA"}\NormalTok{))}
  \KeywordTok{plot}\NormalTok{(}\KeywordTok{start}\NormalTok{(vcf) }\OperatorTok{+}\StringTok{ }\NormalTok{chrOffset[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(vcf))], }\KeywordTok{getAltCount}\NormalTok{(vcf)}\OperatorTok{/}\KeywordTok{getTumorDepth}\NormalTok{(vcf),}\DataTypeTok{col=}\NormalTok{col[cls], }\DataTypeTok{xlab=}\StringTok{''}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"VAF"}\NormalTok{, }\DataTypeTok{pch=}\KeywordTok{ifelse}\NormalTok{(}\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{pMutCNTail }\OperatorTok{<}\StringTok{ }\FloatTok{0.025} \OperatorTok{|}\StringTok{ }\KeywordTok{info}\NormalTok{(vcf)}\OperatorTok{$}\NormalTok{pMutCNTail }\OperatorTok{>}\StringTok{ }\FloatTok{0.975}\NormalTok{, pch.out , pch), }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,chrOffset[}\StringTok{"MT"}\NormalTok{]), }\DataTypeTok{xaxt=}\StringTok{"n"}\NormalTok{, }\DataTypeTok{cex=}\NormalTok{cex)}
  \ControlFlowTok{if}\NormalTok{(title)\{}
    \KeywordTok{title}\NormalTok{(}\DataTypeTok{main=}\KeywordTok{paste0}\NormalTok{(ID,}\StringTok{", "}\NormalTok{, donor2type[sample2donor[ID]], }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{ploidy="}\NormalTok{,}\KeywordTok{round}\NormalTok{(}\KeywordTok{averagePloidy}\NormalTok{(bb),}\DecValTok{2}\NormalTok{), }\StringTok{", hom="}\NormalTok{,}\KeywordTok{round}\NormalTok{(}\KeywordTok{averageHom}\NormalTok{(bb),}\DecValTok{2}\NormalTok{), }\ControlFlowTok{if}\NormalTok{(IS_WGD) }\StringTok{", WGD"} \ControlFlowTok{else} \StringTok{""}\NormalTok{, }\ControlFlowTok{if}\NormalTok{(NO_CLUSTER) }\StringTok{", (No clusters available)"} \ControlFlowTok{else}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{", clusters=("}\NormalTok{,}\KeywordTok{paste}\NormalTok{(}\KeywordTok{round}\NormalTok{(clusters}\OperatorTok{$}\NormalTok{proportion, }\DecValTok{2}\NormalTok{), }\DataTypeTok{collapse=}\StringTok{"; "}\NormalTok{),}\StringTok{")"}\NormalTok{))), }\DataTypeTok{font.main=}\DecValTok{1}\NormalTok{, }\DataTypeTok{line=}\DecValTok{1}\NormalTok{, }\DataTypeTok{cex.main=}\DecValTok{1}\NormalTok{)}
\NormalTok{  \} }
  \KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{], }\DataTypeTok{lty=}\NormalTok{lty.grid, }\DataTypeTok{col=}\NormalTok{col.grid)}
  \ControlFlowTok{if}\NormalTok{(xaxt) }\KeywordTok{mtext}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{line=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=}\NormalTok{chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{diff}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{])}\OperatorTok{/}\DecValTok{2}\NormalTok{, }\DataTypeTok{text=}\KeywordTok{names}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{]))}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{sapply}\NormalTok{(bb}\OperatorTok{$}\NormalTok{timing_param, is.null))) \{}
\NormalTok{    s <-}\StringTok{ }\KeywordTok{start}\NormalTok{(bb)[i]}
\NormalTok{    e <-}\StringTok{ }\KeywordTok{end}\NormalTok{(bb)[i]}
\NormalTok{    x <-}\StringTok{ }\NormalTok{chrOffset[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb)[i])]}
\NormalTok{    y <-}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{timing_param[[i]][,}\StringTok{"f"}\NormalTok{]}
\NormalTok{    l <-}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{timing_param[[i]][,}\StringTok{"pi.s"}\NormalTok{] }\OperatorTok{*}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{timing_param[[i]][,}\StringTok{"P.m.sX"}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(}\KeywordTok{c}\NormalTok{(s,e,x,y,l)))) }\ControlFlowTok{next}
    \KeywordTok{segments}\NormalTok{(s}\OperatorTok{+}\NormalTok{x,y,e}\OperatorTok{+}\NormalTok{x,y, }\DataTypeTok{lwd=}\NormalTok{l}\OperatorTok{*}\DecValTok{4}\OperatorTok{+}\NormalTok{.}\DecValTok{1}\NormalTok{)}
    \CommentTok{#text(x=(s+e)/2 +x, y=y, paste(signif(bb$timing_param[[i]][,"m"],2),signif(bb$timing_param[[i]][,"cfi"]/purityPloidy[meta(header(vv))["ID",1],"purity"],2), sep=":"), pos=3, cex=0.5)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{(legend) }\KeywordTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\DataTypeTok{pch=}\DecValTok{19}\NormalTok{, }\DataTypeTok{col=}\NormalTok{col, }\DataTypeTok{legend=}\KeywordTok{paste}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{table}\NormalTok{(cls)), }\KeywordTok{levels}\NormalTok{(cls)), }\DataTypeTok{bg=}\StringTok{'white'}\NormalTok{)}
\NormalTok{\}}

\NormalTok{timeToBeta <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(time)\{}
\NormalTok{  mu <-}\StringTok{ }\NormalTok{time[,}\DecValTok{1}\NormalTok{]}
  \CommentTok{#if(any(is.na(time))) return(c(NA,NA))}
\NormalTok{  mu <-}\StringTok{ }\KeywordTok{pmax}\NormalTok{(}\FloatTok{1e-3}\NormalTok{, }\KeywordTok{pmin}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\FloatTok{1e-3}\NormalTok{, mu))}
\NormalTok{  v <-}\StringTok{ }\NormalTok{(}\FloatTok{0.5} \OperatorTok{*}\StringTok{ }\NormalTok{(}\KeywordTok{pmax}\NormalTok{(mu,time[,}\DecValTok{3}\NormalTok{])}\OperatorTok{-}\KeywordTok{pmin}\NormalTok{(mu,time[,}\DecValTok{2}\NormalTok{])))}\OperatorTok{^}\DecValTok{2}
\NormalTok{  alpha <-}\StringTok{ }\NormalTok{mu }\OperatorTok{*}\StringTok{ }\NormalTok{(mu }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{mu) }\OperatorTok{/}\StringTok{ }\NormalTok{v }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{  beta <-}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{mu) }\OperatorTok{*}\StringTok{  }\NormalTok{(mu }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{mu) }\OperatorTok{/}\StringTok{ }\NormalTok{v }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
  \KeywordTok{return}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(alpha, beta))}
\NormalTok{\}}

\NormalTok{plotTiming <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb, }\DataTypeTok{time=}\KeywordTok{mcols}\NormalTok{(bb)[,}\KeywordTok{c}\NormalTok{(}\StringTok{"type"}\NormalTok{,}\StringTok{"time"}\NormalTok{,}\StringTok{"time.lo"}\NormalTok{,}\StringTok{"time.up"}\NormalTok{)], }\DataTypeTok{col=}\KeywordTok{paste0}\NormalTok{(RColorBrewer}\OperatorTok{::}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{5}\NormalTok{,}\StringTok{"Set2"}\NormalTok{)[}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\OperatorTok{:}\DecValTok{5}\NormalTok{)],}\StringTok{"88"}\NormalTok{), }\DataTypeTok{legend=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{col.grid=}\StringTok{'grey'}\NormalTok{, }\DataTypeTok{lty.grid=}\DecValTok{1}\NormalTok{)\{}
  \KeywordTok{plot}\NormalTok{(}\OtherTok{NA}\NormalTok{,}\OtherTok{NA}\NormalTok{, }\DataTypeTok{xlab=}\StringTok{''}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Time [mutations]"}\NormalTok{, }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{), }\DataTypeTok{xlim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,chrOffset[}\StringTok{"MT"}\NormalTok{]), }\DataTypeTok{xaxt=}\StringTok{"n"}\NormalTok{)}
  \KeywordTok{try}\NormalTok{(\{}
\NormalTok{    bb <-}\StringTok{ }\NormalTok{bb[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time)]}
\NormalTok{    s <-}\StringTok{ }\KeywordTok{start}\NormalTok{(bb)}
\NormalTok{    e <-}\StringTok{ }\KeywordTok{end}\NormalTok{(bb)}
\NormalTok{    x <-}\StringTok{ }\NormalTok{chrOffset[}\KeywordTok{as.character}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb))]}
\NormalTok{    y <-}\StringTok{ }\NormalTok{time[,}\DecValTok{2}\NormalTok{]}
    \KeywordTok{rect}\NormalTok{(s}\OperatorTok{+}\NormalTok{x,time[,}\DecValTok{3}\NormalTok{],e}\OperatorTok{+}\NormalTok{x,time[,}\DecValTok{4}\NormalTok{], }\DataTypeTok{border=}\OtherTok{NA}\NormalTok{, }\DataTypeTok{col=}\NormalTok{col[time[,}\DecValTok{1}\NormalTok{]], }\DataTypeTok{angle =} \KeywordTok{ifelse}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.star}\OperatorTok{==}\StringTok{"*"} \OperatorTok{|}\StringTok{ }\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.star),}\DecValTok{45}\NormalTok{,}\DecValTok{135}\NormalTok{), }\DataTypeTok{density=}\KeywordTok{ifelse}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.star }\OperatorTok{==}\StringTok{ "***"}\NormalTok{, }\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{72}\NormalTok{))}
    \KeywordTok{segments}\NormalTok{(s}\OperatorTok{+}\NormalTok{x,y,e}\OperatorTok{+}\NormalTok{x,y)}
\NormalTok{  \}, }\DataTypeTok{silent=}\OtherTok{FALSE}\NormalTok{)}
  \KeywordTok{abline}\NormalTok{(}\DataTypeTok{v =}\NormalTok{ chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{], }\DataTypeTok{lty=}\NormalTok{lty.grid, }\DataTypeTok{col=}\NormalTok{col.grid)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{22}\NormalTok{, }\StringTok{"X"}\NormalTok{,}\StringTok{"Y"}\NormalTok{)}
\NormalTok{  l <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(refLengths[}\KeywordTok{seqnames}\NormalTok{(refLengths) }\OperatorTok{%in%}\StringTok{ }\NormalTok{s]))}
  \KeywordTok{names}\NormalTok{(l) <-}\StringTok{ }\NormalTok{s}
\NormalTok{  c <-}\StringTok{ }\KeywordTok{cumsum}\NormalTok{(l)}
  \KeywordTok{axis}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,c), }\DataTypeTok{labels=}\KeywordTok{rep}\NormalTok{(}\StringTok{''}\NormalTok{, }\KeywordTok{length}\NormalTok{(l)}\OperatorTok{+}\DecValTok{1}\NormalTok{))}
  \KeywordTok{mtext}\NormalTok{(}\DataTypeTok{side=}\DecValTok{1}\NormalTok{, }\DataTypeTok{line=}\DecValTok{1}\NormalTok{, }\DataTypeTok{at=}\NormalTok{chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{] }\OperatorTok{+}\StringTok{ }\KeywordTok{diff}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{25}\NormalTok{])}\OperatorTok{/}\DecValTok{2}\NormalTok{, }\DataTypeTok{text=}\KeywordTok{names}\NormalTok{(chrOffset[}\DecValTok{1}\OperatorTok{:}\DecValTok{24}\NormalTok{]))}
  \ControlFlowTok{if}\NormalTok{(legend) }\KeywordTok{legend}\NormalTok{(}\StringTok{"topleft"}\NormalTok{, }\KeywordTok{levels}\NormalTok{(time[,}\DecValTok{1}\NormalTok{]), }\DataTypeTok{fill=}\NormalTok{col, }\DataTypeTok{bg=}\StringTok{"white"}\NormalTok{)}
\NormalTok{\}}

\KeywordTok{source}\NormalTok{(}\StringTok{"../modules/MutationTime.R/MutationTime.R"}\NormalTok{)}

\NormalTok{findMainCluster <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb, }\DataTypeTok{min.dist=}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{  w <-}\StringTok{ }\KeywordTok{which}\NormalTok{(bb}\OperatorTok{$}\NormalTok{n.snv_mnv }\OperatorTok{>}\StringTok{ }\DecValTok{20} \OperatorTok{&}\StringTok{ }\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time))}
  \CommentTok{# d <- dist(bb$time[w])}
  \CommentTok{# ci <- weighted.mean((bb$time.up - bb$time.lo)[w], width(bb)[w])}
  \CommentTok{# h <- hclust(d, method='average', members=bb$n.snv_mnv[w])}
  \CommentTok{# c <- cutree(h, h=ci)}
  \CommentTok{# ww <- c==which.max(table(c))}
  \CommentTok{# weighted.mean(bb$time[w][ww], 1/((bb$time.up - bb$time.lo + min.dist)[w][ww]), na.rm=TRUE)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\FloatTok{0.01}\NormalTok{)}
\NormalTok{  l2 <-}\StringTok{ }\KeywordTok{pmin}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.lo, bb}\OperatorTok{$}\NormalTok{time }\OperatorTok{-}\StringTok{ }\NormalTok{min.dist)[w]}
\NormalTok{  u2 <-}\StringTok{ }\KeywordTok{pmax}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.up, bb}\OperatorTok{$}\NormalTok{time }\OperatorTok{+}\StringTok{ }\NormalTok{min.dist)[w]}
\NormalTok{  l1 <-}\StringTok{ }\NormalTok{(l2 }\OperatorTok{+}\StringTok{  }\NormalTok{bb}\OperatorTok{$}\NormalTok{time[w])}\OperatorTok{/}\DecValTok{2}
\NormalTok{  u1 <-}\StringTok{ }\NormalTok{(u2}\OperatorTok{+}\StringTok{  }\NormalTok{bb}\OperatorTok{$}\NormalTok{time[w])}\OperatorTok{/}\DecValTok{2}
\NormalTok{  wd <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb)[w])}
\NormalTok{  o <-}\StringTok{ }\KeywordTok{sapply}\NormalTok{(s, }\ControlFlowTok{function}\NormalTok{(i) }\KeywordTok{sum}\NormalTok{(wd }\OperatorTok{*}\StringTok{ }\NormalTok{( (l2 }\OperatorTok{<=}\StringTok{ }\NormalTok{i }\OperatorTok{&}\StringTok{ }\NormalTok{u2 }\OperatorTok{>=}\NormalTok{i) }\OperatorTok{+}\StringTok{ }\NormalTok{(l1 }\OperatorTok{<=}\StringTok{ }\NormalTok{i }\OperatorTok{&}\StringTok{ }\NormalTok{u1 }\OperatorTok{>=}\StringTok{ }\NormalTok{i))))}
\NormalTok{  s[}\KeywordTok{which.max}\NormalTok{(o)]}
\NormalTok{\}}

\NormalTok{fractionGenomeWgdCompatible <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb, }\DataTypeTok{min.dist=}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{  m <-}\StringTok{ }\KeywordTok{findMainCluster}\NormalTok{(bb)}
\NormalTok{  l <-}\StringTok{ }\KeywordTok{pmin}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.lo, bb}\OperatorTok{$}\NormalTok{time }\OperatorTok{-}\StringTok{ }\NormalTok{min.dist)}
\NormalTok{  u <-}\StringTok{ }\KeywordTok{pmax}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.up, bb}\OperatorTok{$}\NormalTok{time }\OperatorTok{+}\StringTok{ }\NormalTok{min.dist)}
\NormalTok{  w <-}\StringTok{ }\KeywordTok{which}\NormalTok{(l }\OperatorTok{<=}\StringTok{ }\NormalTok{m }\OperatorTok{&}\StringTok{ }\NormalTok{u }\OperatorTok{>=}\StringTok{ }\NormalTok{m)}
\NormalTok{  avgCi <-}\StringTok{ }\KeywordTok{weighted.mean}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time.up}\OperatorTok{-}\StringTok{ }\NormalTok{bb}\OperatorTok{$}\NormalTok{time.lo, }\KeywordTok{width}\NormalTok{(bb), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{  sd.wgd <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{weighted.mean}\NormalTok{((bb}\OperatorTok{$}\NormalTok{time[w] }\OperatorTok{-}\StringTok{ }\NormalTok{m)}\OperatorTok{^}\DecValTok{2}\NormalTok{, }\KeywordTok{width}\NormalTok{(bb)[w], }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{))}
\NormalTok{  sd.all <-}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{weighted.mean}\NormalTok{((bb}\OperatorTok{$}\NormalTok{time }\OperatorTok{-}\StringTok{ }\NormalTok{m)}\OperatorTok{^}\DecValTok{2}\NormalTok{, }\KeywordTok{width}\NormalTok{(bb), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{))}
  \KeywordTok{c}\NormalTok{(}\DataTypeTok{nt.wgd=}\KeywordTok{sum}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb))[w]), }\DataTypeTok{nt.total=}\KeywordTok{sum}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(bb))[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time)]), }\DataTypeTok{time.wgd=}\NormalTok{m, }\DataTypeTok{n.wgd=}\KeywordTok{length}\NormalTok{(w), }\DataTypeTok{n.all =} \KeywordTok{sum}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time)), }\DataTypeTok{chr.wgd =} \KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb)[w])), }\DataTypeTok{chr.all =} \KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{seqnames}\NormalTok{(bb)[}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(bb}\OperatorTok{$}\NormalTok{time)])), }\DataTypeTok{sd.wgd=}\NormalTok{sd.wgd, }\DataTypeTok{avg.ci=}\NormalTok{avgCi, }\DataTypeTok{sd.all=}\NormalTok{sd.all) }
\NormalTok{\}}

\NormalTok{flattenBB <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb)\{}
\NormalTok{  u <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(bb)}
\NormalTok{  d <-}\StringTok{ }\KeywordTok{duplicated}\NormalTok{(bb)}
  \KeywordTok{mcols}\NormalTok{(u) <-}\StringTok{ }\KeywordTok{mcols}\NormalTok{(u)[}\DecValTok{1}\OperatorTok{:}\DecValTok{7}\NormalTok{]}
\NormalTok{  u}\OperatorTok{$}\NormalTok{total_cn_}\DecValTok{2}\NormalTok{ <-}\StringTok{ }\NormalTok{u}\OperatorTok{$}\NormalTok{major_cn_}\DecValTok{2}\NormalTok{ <-}\StringTok{ }\NormalTok{u}\OperatorTok{$}\NormalTok{minor_cn_}\DecValTok{2}\NormalTok{ <-}\StringTok{ }\KeywordTok{as.integer}\NormalTok{(}\OtherTok{NA}\NormalTok{)}
\NormalTok{  u}\OperatorTok{$}\NormalTok{clonal_frequency_}\DecValTok{2}\NormalTok{ <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\DecValTok{0}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{any}\NormalTok{(d))\{}
\NormalTok{    s <-}\StringTok{ }\NormalTok{bb[d]}
\NormalTok{    f <-}\StringTok{ }\KeywordTok{findOverlaps}\NormalTok{(s, u, }\DataTypeTok{select=}\StringTok{'first'}\NormalTok{)}
    \KeywordTok{mcols}\NormalTok{(u)[f, }\KeywordTok{c}\NormalTok{(}\StringTok{"total_cn_2"}\NormalTok{,}\StringTok{"major_cn_2"}\NormalTok{,}\StringTok{"minor_cn_2"}\NormalTok{,}\StringTok{"clonal_frequency_2"}\NormalTok{)] <-}\StringTok{ }\KeywordTok{mcols}\NormalTok{(s)[, }\KeywordTok{c}\NormalTok{(}\StringTok{"total_cn"}\NormalTok{,}\StringTok{"major_cn"}\NormalTok{,}\StringTok{"minor_cn"}\NormalTok{,}\StringTok{"clonal_frequency"}\NormalTok{)]}
\NormalTok{  \}}
\NormalTok{  u}
\NormalTok{\}}

\NormalTok{reduceBB <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb)\{}
\NormalTok{  b <-}\StringTok{ }\KeywordTok{split}\NormalTok{(bb, }\KeywordTok{do.call}\NormalTok{(}\StringTok{"paste"}\NormalTok{, }\KeywordTok{mcols}\NormalTok{(bb)[}\KeywordTok{c}\NormalTok{(}\StringTok{"clonal_frequency"}\NormalTok{,}\StringTok{"major_cn"}\NormalTok{,}\StringTok{"minor_cn"}\NormalTok{)]))}
\NormalTok{  r <-}\StringTok{ }\KeywordTok{reduce}\NormalTok{(b)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{sort}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(r))}
\NormalTok{  d <-}\StringTok{ }\KeywordTok{DataFrame}\NormalTok{(}\KeywordTok{t}\NormalTok{(}\KeywordTok{sapply}\NormalTok{(}\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{names}\NormalTok{(s), }\StringTok{" "}\NormalTok{), as.numeric)))}
  \KeywordTok{names}\NormalTok{(d) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"clonal_frequency"}\NormalTok{,}\StringTok{"major_cn"}\NormalTok{,}\StringTok{"minor_cn"}\NormalTok{)}\CommentTok{#names(mcols(bb))}
  \KeywordTok{mcols}\NormalTok{(s) <-}\StringTok{ }\NormalTok{d}
  \KeywordTok{names}\NormalTok{(s) <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  u <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(bb)}
\NormalTok{  f <-}\StringTok{ }\KeywordTok{findOverlaps}\NormalTok{(s, u)}
\NormalTok{  t <-}\StringTok{ }\KeywordTok{table}\NormalTok{(}\KeywordTok{subjectHits}\NormalTok{(f), }\KeywordTok{queryHits}\NormalTok{(f))}
\NormalTok{  s}\OperatorTok{$}\NormalTok{n.snv_mnv <-}\StringTok{ }\NormalTok{u}\OperatorTok{$}\NormalTok{n.snv_mnv }\OperatorTok{%*%}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(t)}
\NormalTok{  s}\OperatorTok{$}\NormalTok{total_cn <-}\StringTok{ }\NormalTok{s}\OperatorTok{$}\NormalTok{major_cn }\OperatorTok{+}\StringTok{ }\NormalTok{s}\OperatorTok{$}\NormalTok{minor_cn}
\NormalTok{  s}\OperatorTok{$}\NormalTok{timing_param <-}\StringTok{ }\KeywordTok{vector}\NormalTok{(}\DataTypeTok{mode=}\StringTok{"list"}\NormalTok{, }\DataTypeTok{length=}\KeywordTok{length}\NormalTok{(s))}
\NormalTok{  s}\OperatorTok{$}\NormalTok{timing_param[}\KeywordTok{subjectHits}\NormalTok{(f)] <-}\StringTok{ }\NormalTok{u}\OperatorTok{$}\NormalTok{timing_param[}\KeywordTok{queryHits}\NormalTok{(f)]}
  \KeywordTok{return}\NormalTok{(s)}
\NormalTok{\}}

\NormalTok{plotSample <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(w, }\DataTypeTok{vcf =}\NormalTok{ finalSnv[[w]],  }\DataTypeTok{bb =}\NormalTok{ finalBB[[w]], }\DataTypeTok{title=}\NormalTok{w) \{}
\NormalTok{  p <-}\StringTok{ }\KeywordTok{par}\NormalTok{()}
\NormalTok{  stackTime <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(bb, }\DataTypeTok{t=}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\FloatTok{0.01}\NormalTok{))\{}
\NormalTok{    u <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(bb)}
\NormalTok{    w <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{width}\NormalTok{(u))}
\NormalTok{    f <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{pmin}\NormalTok{(}\KeywordTok{pmax}\NormalTok{(x,}\FloatTok{0.01}\NormalTok{),}\FloatTok{0.99}\NormalTok{)}
\NormalTok{    ut <-}\StringTok{ }\KeywordTok{f}\NormalTok{((}\FloatTok{0.5}\OperatorTok{*}\DecValTok{5}\OperatorTok{+}\NormalTok{u}\OperatorTok{$}\NormalTok{time }\OperatorTok{*}\StringTok{ }\NormalTok{u}\OperatorTok{$}\NormalTok{n.snv_mnv)}\OperatorTok{/}\NormalTok{(}\DecValTok{5}\OperatorTok{+}\NormalTok{u}\OperatorTok{$}\NormalTok{n.snv_mnv))}
\NormalTok{    uu <-}\StringTok{ }\KeywordTok{f}\NormalTok{(u}\OperatorTok{$}\NormalTok{time.up)}
\NormalTok{    ul <-}\StringTok{ }\KeywordTok{f}\NormalTok{(u}\OperatorTok{$}\NormalTok{time.lo)}
    \KeywordTok{diff}\NormalTok{(car}\OperatorTok{::}\KeywordTok{logit}\NormalTok{(}\KeywordTok{f}\NormalTok{(t))) }\OperatorTok{*}\StringTok{ }\KeywordTok{rowSums}\NormalTok{(}\KeywordTok{sapply}\NormalTok{(}\KeywordTok{which}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(ut)), }\ControlFlowTok{function}\NormalTok{(i) w[i]}\OperatorTok{*}\KeywordTok{dnorm}\NormalTok{(car}\OperatorTok{::}\KeywordTok{logit}\NormalTok{(t[}\OperatorTok{-}\DecValTok{1}\NormalTok{] }\OperatorTok{-}\StringTok{ }\KeywordTok{diff}\NormalTok{(t)}\OperatorTok{/}\DecValTok{2}\NormalTok{), }\DataTypeTok{mean=}\NormalTok{car}\OperatorTok{::}\KeywordTok{logit}\NormalTok{(ut[i]), }\DataTypeTok{sd=}\NormalTok{ (car}\OperatorTok{::}\KeywordTok{logit}\NormalTok{(uu[i]) }\OperatorTok{-}\StringTok{ }\NormalTok{car}\OperatorTok{::}\KeywordTok{logit}\NormalTok{(ul[i]) }\OperatorTok{+}\StringTok{ }\FloatTok{0.05}\NormalTok{)}\OperatorTok{/}\DecValTok{4}\NormalTok{)))}\CommentTok{#(t <= u$time.up[i] & t >= u$time.lo[i])))}
    \CommentTok{#rowSums(sapply(which(!is.na(ut)), function(i) w[i]*(t <= u$time.up[i] & t >= u$time.lo[i])))}
\NormalTok{  \}}
  \KeywordTok{layout}\NormalTok{(}\KeywordTok{matrix}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{3}\NormalTok{, }\DataTypeTok{ncol=}\DecValTok{1}\NormalTok{), }\DataTypeTok{height=}\KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\FloatTok{1.2}\NormalTok{,}\FloatTok{3.5}\NormalTok{))}
  \KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\DecValTok{3}\NormalTok{,}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.5}\NormalTok{), }\DataTypeTok{mgp=}\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\FloatTok{0.25}\NormalTok{,}\DecValTok{0}\NormalTok{), }\DataTypeTok{bty=}\StringTok{"L"}\NormalTok{, }\DataTypeTok{las=}\DecValTok{2}\NormalTok{, }\DataTypeTok{tcl=}\OperatorTok{-}\FloatTok{0.25}\NormalTok{, }\DataTypeTok{cex=}\DecValTok{1}\NormalTok{)}
  \KeywordTok{plotVcf}\NormalTok{(vcf, bb, finalClusters[[w]], }\DataTypeTok{title=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{col.grid=}\StringTok{'white'}\NormalTok{,  }\DataTypeTok{xaxt=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{cex=}\FloatTok{0.33}\NormalTok{)}
  \KeywordTok{mtext}\NormalTok{(}\DataTypeTok{line=}\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DataTypeTok{side=}\DecValTok{3}\NormalTok{, title, }\DataTypeTok{las=}\DecValTok{1}\NormalTok{)}
  \KeywordTok{plotBB}\NormalTok{(bb, }\DataTypeTok{ylim=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{), }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{type=}\StringTok{'bar'}\NormalTok{, }\DataTypeTok{col.grid=}\StringTok{'white'}\NormalTok{, }\DataTypeTok{col=}\KeywordTok{c}\NormalTok{(}\StringTok{"lightgrey"}\NormalTok{, }\StringTok{"darkgrey"}\NormalTok{), }\DataTypeTok{xaxt=}\OtherTok{FALSE}\NormalTok{)}
  \KeywordTok{par}\NormalTok{(}\DataTypeTok{mar=}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{,}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.5}\NormalTok{))}
  \KeywordTok{plotTiming}\NormalTok{(bb, }\DataTypeTok{legend=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{col.grid=}\OtherTok{NA}\NormalTok{)}
\NormalTok{  s <-}\StringTok{ }\KeywordTok{stackTime}\NormalTok{(bb)}
\NormalTok{  g <-}\StringTok{ }\KeywordTok{colorRampPalette}\NormalTok{(RColorBrewer}\OperatorTok{::}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{4}\NormalTok{,}\StringTok{"Set1"}\NormalTok{)[}\KeywordTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)])(}\DecValTok{100}\NormalTok{)}
  \KeywordTok{segments}\NormalTok{(}\DataTypeTok{x0=}\NormalTok{chrOffset[}\StringTok{"MT"}\NormalTok{] ,}\DataTypeTok{y0=}\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DataTypeTok{l=}\DecValTok{100}\NormalTok{),}\DataTypeTok{x1=}\NormalTok{chrOffset[}\StringTok{"MT"}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{s}\OperatorTok{/}\KeywordTok{max}\NormalTok{(s) }\OperatorTok{*}\StringTok{ }\FloatTok{1e8}\NormalTok{, }\DataTypeTok{col=}\NormalTok{g, }\DataTypeTok{lend=}\DecValTok{3}\NormalTok{)}
  \CommentTok{#print(w)}
  \KeywordTok{par}\NormalTok{(p[}\KeywordTok{setdiff}\NormalTok{(}\KeywordTok{names}\NormalTok{(p), }\KeywordTok{c}\NormalTok{(}\StringTok{"cin"}\NormalTok{,}\StringTok{"cra"}\NormalTok{,}\StringTok{"csi"}\NormalTok{,}\StringTok{"cxy"}\NormalTok{,}\StringTok{"din"}\NormalTok{,}\StringTok{"page"}\NormalTok{))])}
\NormalTok{\}}

\NormalTok{t <-}\StringTok{ }\KeywordTok{read.table}\NormalTok{(}\StringTok{"../ref/release_may2016.v1.1.TiN__donor.TiNsorted.20Jul2016.tsv"}\NormalTok{, }\DataTypeTok{header=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{sep=}\StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{TiN <-}\StringTok{ }\NormalTok{t}\OperatorTok{$}\NormalTok{TiN_donor}
\KeywordTok{names}\NormalTok{(TiN) <-}\StringTok{ }\NormalTok{t}\OperatorTok{$}\NormalTok{icgc_donor_id}
\end{Highlighting}
\end{Shaded}


\end{document}
